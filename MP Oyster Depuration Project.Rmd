---
title: "MP Oyster Depuration Project"
author: "Garth C"
date: "January 9, 2018"
output: word_document
---
## Load libraries
Load the libraries we'll need. You'll have to install these if you don"t already have them.

```{r}
library(plyr)
library(reshape2)
library(ggplot2)
library(glmmTMB)
library(MuMIn)
library(lme4)
library(dplyr)
library(DHARMa)

theme1 <-
  theme_bw() +
  theme(
    text = element_text(size = 7),
    axis.text = element_text(size = 7),
    strip.background = element_blank(),
    strip.text = element_text(size = 7),
    legend.text = element_text(size = 7),
    panel.grid = element_blank()
  )
```

## Oyster data

Import the oyster depuration data and view it.

```{r}
oysterdep <- 
  read.csv("oysterdep.csv")

head(oysterdep)
```

Get all of the variables into the right format.

```{r}
oysterdep$id <- as.factor(oysterdep$id)
oysterdep$sampleday <- as.factor(oysterdep$sampleday)
oysterdep$size.cat <- as.factor(oysterdep$size.cat)
oysterdep$Table <- as.factor(oysterdep$Table)
oysterdep$Tank <- as.factor(oysterdep$Tank)
oysterdep$observer <- as.factor(oysterdep$observer)
```

Make a new dataframe to work with and rename size categories.

```{r}
oysterdep2 <- oysterdep

oysterdep2$size.cat <- factor(oysterdep2$size.cat, 
                              levels=c("twentyto50", "fiftyto100",
                                       "onehundredto500", "fivehundredto1000", 
                                       "onethousandto5000"))  # reorder


oysterdep2$size.cat <- mapvalues(oysterdep2$size.cat, 
                                 from = c("twentyto50", "fiftyto100", 
                                          "onehundredto500", 
                                          "fivehundredto1000", 
                                          "onethousandto5000"), 
                                 to = c("20-50", "50-100", "100-500",
                                        "500-1000", "1000-5000"))  # rename
summary(oysterdep2$size.cat)  # view
```

We need to melt the dataframe so that the particle types are organized by row instead of by column.

```{r}
oysterdep3 <- melt(oysterdep2,
                   id.vars = c("id", "sampleday", "size.cat", "Table",
                               "Tank", "species", "DOFSample", "length", 
                               "width", "depth", "cont.weight", 
                               "cont.dryweight", "dry.weight", 
                               "shell.dry.weight", "CI", "time.in.oven", 
                               "time.out.oven", "dat.filter", "dat.count", 
                               "observer"))

##  Take out unnecessary columns

oysterdep3 <- oysterdep3[c("id", "sampleday", "size.cat", "Table", "Tank", 
                         "DOFSample", "length", "width", "depth", "dry.weight",
                         "shell.dry.weight", "CI", "dat.filter", "dat.count",
                         "observer", "variable", "value")]

head(oysterdep3)  # now "variable" is particle category and "value is the count"
```

Get rid of the <100 micron particles as we"re not confident in these.

```{r}
oysterdep3 <- subset(oysterdep3, size.cat != "20-50" & size.cat != "50-100")

oysterdep3$size.cat <- as.character(oysterdep3$size.cat)
oysterdep3$size.cat <- as.factor(oysterdep3$size.cat)

cat.sums <- aggregate(oysterdep3$value ~ 
                        oysterdep3$variable, FUN = sum)  # sums everything
print(cat.sums)
```

So we can remove the empty categories.

```{r}
oysterdep4 <- subset(oysterdep3, 
                     variable == "red.fib" |
                       variable == "yell.fib" |
                       variable == "green.fib" |
                       variable == "turq.fib" |
                       variable == "blu.fib" |
                       variable == "clear.fib" |
                       variable == "pink.fib" |
                       variable == "brown.fib" |
                       variable == "orang.fib" |
                       variable == "black.fib" |
                       variable == "clear.frag" |
                       variable == "whit.spher")  # keeps all these rows

oysterdep4$variable <- as.character(oysterdep4$variable)
oysterdep4$variable <- as.factor(oysterdep4$variable)  # gets rid of unused names

summary(oysterdep4$variable)  # view
```

Let"s make the category names a bit more useful for plotting

```{r}
oysterdep4$variable <- mapvalues(oysterdep4$variable,
                                 from = c(levels(oysterdep4$variable)), 
                                 to = c("Black fibres", 
                                        "Blue fibres",
                                        "Brown fibres",
                                        "Clear fibres",
                                        "Clear fragments",
                                        "Green fibres",
                                        "Orange fibres",
                                        "Pink fibres",
                                        "Red fibres",
                                        "Turquoise fibres", 
                                        "White spheres",
                                        "Yellow fibres"))

summary(oysterdep4$variable)
```

## Oyster blanks
Now load in the blanks dataset and set it up for plotting, same as with the oyster data set. First we load in the data.

```{r}
depblanks <- 
  read.csv("depblanks.csv")

head(depblanks)

depblanks$id <- as.factor(depblanks$id)
depblanks$size.cat <- as.factor(depblanks$size.cat)
depblanks$observer <- as.factor(depblanks$observer)
depblanks$sampleday <- as.factor(depblanks$sampleday)
```

Now we make a new dataframe to work with and rename size categories.

```{r}
depblanks2 <- depblanks

depblanks2$size.cat <- factor(depblanks2$size.cat, 
                              levels=c("twentyto50", "fiftyto100",
                                       "onehundredto500", "fivehundredto1000", 
                                       "onethousandto5000"))  # reorder


depblanks2$size.cat <- mapvalues(depblanks2$size.cat, 
                                 from = c("twentyto50", "fiftyto100", 
                                          "onehundredto500", 
                                          "fivehundredto1000", 
                                          "onethousandto5000"), 
                                 to = c("20-50", "50-100", "100-500",
                                        "500-1000", "1000-5000"))  # rename
summary(depblanks2$size.cat)  # view
```

Again, we melt the dataframe so that the particle types are organized by row instead of by column.

```{r}
depblanks3 <- melt(depblanks2,
                   id.vars = c("id", "size.cat", "sampleday", "DOFSample", 
                               "time.in.oven", "time.out.oven", "dat.filter",
                               "dat.count", "observer"))

##  Take out unnecessary columns

depblanks3 <- depblanks3[c("id", "size.cat", "sampleday", "DOFSample", 
                           "dat.filter", "dat.count", "observer", "variable",
                           "value")]

head(depblanks3)  # now "variable" is particle category and "value is the count"
```

Now sum by totals across all samples and particles sizes to get an idea of what we"re working with. First remove particles less than 100 microns as we"re not confident in them.

```{r}
depblanks3 <- subset(depblanks3, size.cat != "20-50" & size.cat != "50-100")

depblanks3$size.cat <- as.character(depblanks3$size.cat)
depblanks3$size.cat <- as.factor(depblanks3$size.cat)

cat.sums.blanks <- aggregate(depblanks3$value ~ 
                               depblanks3$variable, FUN = sum)  # sums everything
print(cat.sums.blanks)
```

So we can remove everything but blue, clear, and pink fibres.

```{r}
depblanks4 <- subset(depblanks3, 
                     c(variable == "blu.fib" |
                         variable == "clear.fib" |
                         variable == "pink.fib")
                     )  # keep only these rows

depblanks4$variable <- as.character(depblanks4$variable)
depblanks4$variable <- as.factor(depblanks4$variable)  # gets rid of those names

summary(depblanks4$variable)  # view
```

Let"s make the category names a bit more useful for plotting

```{r}
depblanks4$variable <- mapvalues(depblanks4$variable,
                                 from = c(levels(depblanks4$variable)), 
                                 to = c("Blue fibres",
                                        "Clear fibres",
                                        "Pink fibres"))

summary(depblanks4$variable)
```

Next let"s make plots of the distribution of sizes and particle types and colours.

Starting with size

```{r}
## First we need to make a new data frame of sums according to each size category

blankssizesums <- ddply(depblanks4, c("id", "size.cat", "sampleday", 
                                      "DOFSample",  "dat.filter", "dat.count", 
                                      "observer"), summarize, sum = sum(value))



## Now calculate proportions of each particle size category present for each
## sampling day

blanksprop <- ddply(blankssizesums,
                    c("sampleday", "size.cat"), 
                    summarize, 
                    sum = sum(sum))
blanksprop$prop <- numeric(length = nrow(blanksprop))

for(i in 1:nrow(blanksprop)) {
  blanksprop$prop[i] <-
    (blanksprop$sum[i] /
       sum(blanksprop$sum[blanksprop$sampleday == blanksprop$sampleday[i]]))
}

blanksprop$size.cat <- as.character(blanksprop$size.cat)
blanksprop$size.cat <- as.factor(blanksprop$size.cat)

## Put the size categories in order

blanksprop$size.cat <- factor(blanksprop$size.cat,
                              levels = c("10-100",
                                         "100-500", "500-1000",
                                         "1000-5000"))

## Now plot

ggplot(blanksprop, aes(x=sampleday, y=100*prop, fill = size.cat)) + 
  geom_col(size = 1, colour = "black") + 
  xlab("Sampling Day") + 
  ylab("Average percent") +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c("grey25", "grey50", "grey75")) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = c(0,0.5)) + 
  scale_y_continuous(expand = c(0.03,0))

```

Now with particle type/colour

```{r}
## First we need to make a new data frame of sums according to each particle
## type/colour

blankstypesums <- ddply(depblanks4, c("id", "sampleday", "DOFSample", 
                                      "dat.filter", "dat.count", "observer", 
                                      "variable"), 
                        summarize, sum = sum(value))

## Now calculate proportions of each particle type/colour present for each 
## sampling day

blankstypeprop <- ddply(blankstypesums,
                    c("sampleday", "variable"), 
                    summarize, 
                    sum = sum(sum))
blankstypeprop$prop <- numeric(length = nrow(blankstypeprop))

for(i in 1:nrow(blankstypeprop)) {
  blankstypeprop$prop[i] <-
    (blankstypeprop$sum[i] /
       sum(blankstypeprop$sum[blankstypeprop$sampleday == blankstypeprop$sampleday[i]]))
}

blankstypeprop$variable <- as.character(blankstypeprop$variable)
blankstypeprop$variable <- as.factor(blankstypeprop$variable)

## Now plot

ggplot(blankstypeprop, aes(x=sampleday, y=100*prop, fill = variable)) + 
  geom_col(size = 0.5, colour = "black") + 
  xlab("Sampling Day") + 
  ylab("Average percent") +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c("Steel Blue",
                               "Grey90",
                               "Pink")) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = c(0,0.5)) + 
  scale_y_continuous(expand = c(0.03,0))

```

Take total sums and plot the results.

```{r}
totalblanksums <- ddply(depblanks4, c("id", "sampleday", "observer", 
                                      "dat.filter", "DOFSample"),
                   summarise, sum = sum(value))  # adds all the counts together

## Plot according to count per filtration day

ggplot(totalblanksums, aes(x=sampleday, y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab("Day") + 
  ylab("# APs") +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

Now do summary stats for the blanks

```{r}
## medians, range, and SD

with(totalblanksums, tapply(sum, sampleday, median))  # takes median for each day
with(totalblanksums, tapply(sum, sampleday, min))  # takes minimum for each day
with(totalblanksums, tapply(sum, sampleday, max))  # takes maximum for each day
with(totalblanksums, tapply(sum, 
                       sampleday, sd))  # takes standard deviation for each day

## Proportions of particles sizes

sum(depblanks4$value[depblanks4$size.cat == "100-500"])/
  sum(depblanks4$value)*100

sum(depblanks4$value[depblanks4$size.cat == "500-1000"])/
  sum(depblanks4$value)*100

sum(depblanks4$value[depblanks4$size.cat == "1000-5000"])/
  sum(depblanks4$value)*100

## This provides the percentage of total particles found accounted for by each 
## colour/type of particles
blanksummarytable <- with(depblanks4, tapply(value, variable, sum))
blanksummarytable <- blanksummarytable/sum(depblanks4$value)*100
print(blanksummarytable)
```

## Ajusted oyster data

Now subtract the blank counts from the appropriate size and shape categories for the oyster counts.

```{r}
depblanksmean <- ddply(depblanks4, c("size.cat", "sampleday", "dat.filter", 
                                     "variable"),
                       summarize, value.b = mean(value))

depblanksmean$value.b <-
  ceiling(depblanksmean$value.b) ## Round all blank averages up to the nearest whole number

oysterdep5 <-
  left_join(oysterdep4, depblanksmean, 
            by = c("sampleday", "size.cat", "variable")) ## Join the 2 dataframes

oysterdep5$value.b <- as.numeric(oysterdep5$value.b)
oysterdep5$value.b[is.na(oysterdep5$value.b)] <- 0

oysterdep4$variable <- as.factor(oysterdep4$variable)

oysterdep5$finalcount <- (oysterdep5$value - oysterdep5$value.b)

oysterdep5$finalcount[oysterdep5$finalcount < 0] <-
  0 ## Change any negative values to 0

summary(oysterdep5$finalcount)

```

Now run all of the same code again but for the modified oyster counts.

```{r}
## First we need to make a new data frame of sums according to each size category

oystersizesums <- ddply(oysterdep5, c("id", "sampleday", "size.cat", "Table", 
                                      "Tank", "DOFSample", "length", "width",
                                      "depth", "dry.weight", "shell.dry.weight",
                                      "CI", "dat.count", "observer"), 
                        summarize, sum = sum(finalcount))



## Now calculate proportions of each particle size category present for each 
## sampling day

oysterprop <- ddply(oystersizesums,
                    c("sampleday", "size.cat"), 
                    summarize, 
                    sum = sum(sum))
oysterprop$prop <- numeric(length = nrow(oysterprop))

for(i in 1:nrow(oysterprop)) {
  oysterprop$prop[i] <-
    (oysterprop$sum[i] /
       sum(oysterprop$sum[oysterprop$sampleday == oysterprop$sampleday[i]]))
}

oysterprop$size.cat <- as.character(oysterprop$size.cat)
oysterprop$size.cat <- as.factor(oysterprop$size.cat)

oysterprop$size.cat <- 
  factor(oysterprop$size.cat, 
         levels = c("100-500", "500-1000", "1000-5000"))

## Now plot

ggplot(oysterprop, aes(x=sampleday, y=100*prop, fill = size.cat)) + 
  geom_col(size = 1, colour = "black") + 
  xlab("Sampling Day") + 
  ylab("Average percent") +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c("grey25", "grey50", "grey75")) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = c(0,0.5)) + 
  scale_y_continuous(expand = c(0.03,0))

```

Now with particle type/colour

```{r}
## First we need to make a new data frame of sums according to each particle
## type/colour

oystertypesums <- ddply(oysterdep5, 
                        c("id", "sampleday", "Table", "Tank", "DOFSample", 
                          "length", "width", "depth", "dry.weight",
                          "shell.dry.weight", "CI", "dat.count", "observer",
                          "variable"),
                        summarize, 
                        sum = sum(finalcount))



## Now calculate proportions of each particle type/colour present for each
## sampling day

oystertypeprop <- ddply(oystertypesums,
                        c("sampleday", "variable"), 
                        summarize, 
                        sum = sum(sum))
oystertypeprop$prop <- numeric(length = nrow(oystertypeprop))

for(i in 1:nrow(oystertypeprop)) {
  oystertypeprop$prop[i] <-
    (oystertypeprop$sum[i] /
       sum(oystertypeprop$sum[oystertypeprop$sampleday ==
                                oystertypeprop$sampleday[i]]))
}

oystertypeprop$variable <- as.character(oystertypeprop$variable)
oystertypeprop$variable <- as.factor(oystertypeprop$variable)

## Now plot


ggplot(oystertypeprop, aes(x = sampleday, y = 100 * prop, fill = variable)) +
  geom_col(size = 0.5, colour = "black") +
  xlab("Sampling Day") +
  ylab("Average percent") +
  guides(fill = guide_legend(title = "Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(
    values = c(
      "Grey16",
      "Steel Blue",
      "Saddle Brown",
      "Grey90",
      "Grey70",
      "Forest Green",
      "Orange",
      "Pink",
      "Red",
      "Turquoise",
      "White",
      "Yellow"
    )
  ) +
  theme(
    legend.text = element_text(size = 12),
    text = element_text(size = 12),
    panel.spacing = unit(1, "lines"),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12,
                               margin = margin(
                                 t = 0,
                                 r = 0,
                                 b = 0,
                                 l = 2
                               )),
    strip.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.placement = "outside"
  ) +
  scale_x_discrete(expand = c(0, 0.5)) +
  scale_y_continuous(expand = c(0.03, 0))

```

Take total sums overall and plot the results.

```{r}
totalsums <- ddply(oysterdep5, 
                   c("id", "sampleday", "Table", "Tank", "length", "width", 
                     "depth", "dry.weight", "shell.dry.weight", "CI", "observer"),
                   summarise, 
                   sum = sum(finalcount))  # adds all the counts together

## Plot according to count per individual

ggplot(totalsums, aes(x=sampleday , y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab("Day") + 
  coord_cartesian(ylim = c(0, 40)) +
  ylab("# AFs") +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

## Plot according to concentration (particles/dry tissue weight)

ggplot(totalsums, aes(x=sampleday , y=sum/dry.weight)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab("Day") + 
  coord_cartesian(ylim = c(0, 15)) +
  ylab("# AFs/g dry tissue") +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

Let"s print out some summary stats.

```{r}
## Summary stats according to count per individual

with(totalsums2, tapply(sum, sampleday, mean))  # takes mean for each day
with(totalsums2, tapply(sum, sampleday, min))  # takes minimum for each day
with(totalsums2, tapply(sum, sampleday, max))  # takes maximum for each day
with(totalsums2, tapply(sum, 
                       sampleday, sd))  # takes standard deviation for each day

## Summary stats according to concentration

with(totalsums2, tapply(sum/dry.weight, 
                       sampleday, mean))  # takes mean for each day
with(totalsums2, tapply(sum/dry.weight, 
                       sampleday, min))  # takes minimum for each day
with(totalsums2, tapply(sum/dry.weight, 
                       sampleday, max))  # takes maximum for each day
with(totalsums2, tapply(sum/dry.weight, 
                       sampleday, sd))  # takes standard deviation for each day

## Proportions of particles sizes

sum(oystersizesums2$sum[oystersizesums2$size.cat == "100-500"])/
  sum(oystersizesums2$sum)*100

sum(oystersizesums2$sum[oystersizesums2$size.cat == "500-1000"])/
  sum(oystersizesums2$sum)*100

sum(oystersizesums2$sum[oystersizesums2$size.cat == "1000-5000"])/
  sum(oystersizesums2$sum)*100

## This provides the percentage of total particles found accounted for by each 
## colour/type of particles
oystersummarytable <- with(oystertypesums2, tapply(sum, variable, sum))
oystersummarytable <- oystersummarytable/sum(oystertypesums2$sum)*100
print(oystersummarytable)
```

## Water data

Now load in the water sample data.

```{r}
depwater <- 
  read.csv("depwater.csv")

head(depwater)

depwater$id <- as.factor(depwater$id)
depwater$day <- as.factor(depwater$day)
depwater$size.cat <- as.factor(depwater$size.cat)
depwater$Table <- as.factor(depwater$Table)
depwater$Tank <- as.factor(depwater$Tank)
depwater$observer <- as.factor(depwater$observer)
```

Now we make a new dataframe to work with and rename size categories.

```{r}
depwater2 <- depwater

depwater2$size.cat <- factor(depwater2$size.cat, 
                              levels=c("twentyto50", "fiftyto100",
                                       "onehundredto500", "fivehundredto1000", 
                                       "onethousandto5000"))  # reorder


depwater2$size.cat <- mapvalues(depwater2$size.cat, 
                                 from = c("twentyto50", "fiftyto100", 
                                          "onehundredto500", 
                                          "fivehundredto1000", 
                                          "onethousandto5000"), 
                                 to = c("20-50", "50-100", "100-500",
                                        "500-1000", "1000-5000"))  # rename
summary(depwater2$size.cat)  # view
```

Again, we melt the dataframe so that the particle types are organized by row instead of by column.

```{r}
depwater3 <- melt(depwater2,
                   id.vars = c("id", "day", "size.cat", "Table", "Tank", 
                               "DOFSample", "time.in.oven", "time.out.oven", 
                               "dat.filter",  "dat.count", "observer"))

##  Take out unnecessary columns

depwater3 <- depwater3[c("id", "day", "size.cat", "Table", "Tank", "DOFSample", 
                         "dat.filter", "dat.count", "observer", "variable", 
                         "value")]

head(depwater3)  # now "variable" is particle category and "value is the count"
```

Now sum by totals across all samples and particles sizes to get an idea of what we"re working with. First remove particles <100 microns as we don"t trust these counts.

```{r}
depwater3 <- subset(depwater3, size.cat != "20-50" & size.cat != "50-100")

depwater3$size.cat <- as.character(depwater3$size.cat)
depwater3$size.cat <- as.factor(depwater3$size.cat)

cat.sums.blanks <- aggregate(depwater3$value ~ 
                               depwater3$variable, FUN = sum)  # sums everything
print(cat.sums.blanks)
```

So we can remove the yellow, green, purple, gray, pink, brown, orange, and black fibre categories, and all other categories as well.

```{r}
depwater4 <- subset(depwater3, 
                    c(variable == "red.fib" | 
                        variable == "turq.fib" | 
                        variable == "blu.fib" |
                        variable == "clear.fib"))  # keep only these rows

depwater4$variable <- as.character(depwater4$variable)
depwater4$variable <- as.factor(depwater4$variable)  # gets rid of those names

summary(depwater4$variable)  # view
```

Let"s make the category names a bit more useful for plotting

```{r}
depwater4$variable <- mapvalues(depwater4$variable,
                                 from = c(levels(depwater4$variable)), 
                                 to = c("Blue fibres", "Clear fibres", 
                                        "Red fibres", "Turquoise fibres"))

## And reorder them
depwater4$variable <- factor(depwater4$variable, 
                              levels = c("Blue fibres", "Clear fibres",
                                         "Red fibres", "Turquoise fibres"))

summary(depwater4$variable)
```

## Water blanks

Now do all these same things for the water blanks.

```{r}
waterblanks <- read.csv("waterblanks.csv")

head(waterblanks)

waterblanks$id <- as.factor(waterblanks$id)
waterblanks$day <- as.factor(waterblanks$day)
waterblanks$size.cat <- as.factor(waterblanks$size.cat)
waterblanks$Table <- as.factor(waterblanks$Table)
waterblanks$Tank <- as.factor(waterblanks$Tank)
waterblanks$observer <- as.factor(waterblanks$observer)
```

Now we make a new dataframe to work with and rename size categories.

```{r}
waterblanks2 <- waterblanks

waterblanks2$size.cat <- factor(waterblanks2$size.cat, 
                              levels=c("twentyto50", "fiftyto100",
                                       "onehundredto500", "fivehundredto1000", 
                                       "onethousandto5000"))  # reorder


waterblanks2$size.cat <- mapvalues(waterblanks2$size.cat, 
                                 from = c("twentyto50", "fiftyto100", 
                                          "onehundredto500", 
                                          "fivehundredto1000", 
                                          "onethousandto5000"), 
                                 to = c("20-50", "50-100", "100-500",
                                        "500-1000", "1000-5000"))  # rename
summary(waterblanks2$size.cat)  # view
```

Again, we melt the dataframe so that the particle types are organized by row instead of by column.

```{r}
waterblanks3 <- melt(waterblanks2,
                   id.vars = c("id", "day", "size.cat", "Table", "Tank", 
                               "DOFSample", "time.in.oven", "time.out.oven", 
                               "dat.filter",  "dat.count", "observer"))

##  Take out unnecessary columns

waterblanks3 <- waterblanks3[c("id", "day", "size.cat", "Table", "Tank", "DOFSample", 
                         "dat.filter", "dat.count", "observer", "variable", 
                         "value")]

head(waterblanks3)  # now "variable" is particle category and "value is the count"
```

Now sum by totals across all samples and particles sizes to get an idea of what we"re working with. First remove <100 micron particles.

```{r}
waterblanks3 <- subset(waterblanks3, 
                       size.cat != "20-50" & 
                         size.cat != "50-100")

waterblanks3$size.cat <- as.character(waterblanks3$size.cat)
waterblanks3$size.cat <- as.factor(waterblanks3$size.cat)

cat.sums.blanks <- aggregate(waterblanks3$value ~ 
                               waterblanks3$variable, FUN = sum)  # sums everything
print(cat.sums.blanks)
```

So we can remove the red, yellow, green, turquoise, purple, gray, clear, pink, brown, orange, and black fibre categories, and all other categories as well.

```{r}
waterblanks4 <- subset(waterblanks3, variable == "blu.fib")  # keep only these rows

waterblanks4$variable <- as.character(waterblanks4$variable)
waterblanks4$variable <- as.factor(waterblanks4$variable)  # gets rid of those names

summary(waterblanks4$variable)  # view
```

Let"s make the category names a bit more useful for plotting

```{r}
waterblanks4$variable <- mapvalues(waterblanks4$variable,
                                 from = c(levels(waterblanks4$variable)), 
                                 to = "Blue fibres")

summary(waterblanks4$variable)
```

## Adjusted water data

Now subtract the blank counts from the appropriate size and shape categories for the water counts.

```{r}
depwater4$dat.filter <- as.factor(depwater4$dat.filter)
waterblanks4$dat.filter <- as.factor(waterblanks4$dat.filter)

waterblanksmean <- ddply(waterblanks4, c("size.cat", "dat.filter", 
                                     "variable"),
                       summarize, value.b = mean(value))

depwater5 <-
  left_join(depwater4, waterblanksmean, 
            by = c("dat.filter", "size.cat", "variable")) ## Join the 2 dataframes

depwater5$value.b <- as.numeric(depwater5$value.b)
depwater5$value.b[is.na(depwater5$value.b)] <- 0

depwater5$variable <- as.factor(depwater5$variable)

depwater5$finalcount <- (depwater5$value - depwater5$value.b)

depwater5$finalcount[depwater5$finalcount < 0] <-
  0 ## Change any negative values to 0

summary(depwater5$finalcount)
```


```{r}
## First we need to make a new data frame of sums according to each size category

depwater5$day <- factor(depwater5$day, 
                        levels = 
                          c("0", "1", "3", "5", "10"))  # put in order

watersizesums <- ddply(depwater5, 
                       c("id", "day", "size.cat", "Table", "Tank", "DOFSample", 
                         "dat.filter", "dat.count", "observer"), 
                       summarize, 
                       sum = sum(finalcount))

## Now calculate proportions of each particle size category present in each 
## sample and take the means for each sampling day

waterprop <- ddply(watersizesums,
                   c("day", "size.cat"), 
                   summarize, 
                   sum = sum(sum))

waterprop$prop <- numeric(length = nrow(waterprop))

for(i in 1:nrow(waterprop)) {
  waterprop$prop[i] <-
    (waterprop$sum[i] /
       sum(waterprop$sum[waterprop$sampleday == waterprop$sampleday[i]]))
}

waterprop$size.cat <- as.character(waterprop$size.cat)
waterprop$size.cat <- as.factor(waterprop$size.cat)

## Put the size categories in order

waterprop3$size.cat <- factor(waterprop3$size.cat, 
                                  levels = c("10-100", "100-500", "500-1000", 
                                             "1000-5000"))

## Now plot

ggplot(waterprop3, aes(x=day, y=100*mean, fill = size.cat)) + 
  geom_col(size = 1, colour = "black") + 
  xlab("Sampling Day") + 
  ylab("Average percent") +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c("grey25", "grey50", "grey75")) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = expand_scale(0,0.5)) + 
  scale_y_continuous(expand = expand_scale(0.03,0))

```

Now with particle type/colour

```{r}
## First we need to make a new data frame of sums according to each particle
## type/colour

watertypesums <- ddply(depwater5, c("id", "day", "Table", "Tank", 
                                    "DOFSample", "dat.filter", "dat.count", 
                                    "observer", "variable"), 
                        summarize, sum = sum(finalcount))



## Now calculate proportions of each particle type/colour present in each 
## sample and take the means for each sampling day

watertypeprop <- ddply(watertypesums,
                        c("day", "variable"), 
                        summarize, 
                        sum = sum(sum))
watertypeprop$prop <- numeric(length = nrow(watertypeprop))

for(i in 1:nrow(watertypeprop)) {
  watertypeprop$prop[i] <-
    (watertypeprop$sum[i] /
       sum(watertypeprop$sum[watertypeprop$sampleday ==
                                watertypeprop$sampleday[i]]))
}

watertypeprop$variable <- as.character(watertypeprop$variable)
watertypeprop$variable <- as.factor(watertypeprop$variable)

## Now plot

ggplot(watertypeprop3, aes(x=day, y=100*mean, fill = variable)) + 
  geom_col(size = 0.5, colour = "black") + 
  xlab("Sampling Day") + 
  ylab("Average percent") +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c("steel blue", "grey90", "red", "turquoise")) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = expand_scale(0,0.5)) + 
  scale_y_continuous(expand = expand_scale(0.03,0))

```

Take total sums and plot the results.

```{r}
totalwatersums <- ddply(depwater5, c("id", "day", "Table", "Tank", "observer", 
                                     "dat.filter"),
                   summarise, sum = sum(finalcount))  # adds all the counts together

## Plot according to count per filtration day

ggplot(totalwatersums, aes(x=day, y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab("Day") +
  ylab(expression(paste("# AFs"~L^-1))) +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

Now run the same summary stats for the water samples.

```{r}
## medians, range, and SD

with(totalwatersums, tapply(sum, day, median))  # takes median for each day
with(totalwatersums, tapply(sum, day, min))  # takes minimum for each day
with(totalwatersums, tapply(sum, day, max))  # takes maximum for each day
with(totalwatersums, tapply(sum, 
                       day, sd))  # takes standard deviation for each day

## Proportions of particles sizes

sum(depwater5$finalcount[depwater5$size.cat == "100-500"])/
  sum(depwater5$finalcount)*100

sum(depwater5$finalcount[depwater5$size.cat == "500-1000"])/
  sum(depwater5$finalcount)*100

sum(depwater5$finalcount[depwater5$size.cat == "1000-5000"])/
  sum(depwater5$finalcount)*100

## This provides the percentage of total particles found accounted for by each 
## colour/type of particles
watersummarytable <- with(depwater5, tapply(value, variable, sum))
watersummarytable <- watersummarytable/sum(depwater5$finalcount)*100
print(watersummarytable)
```

## Algae data

Now load in the algae sample data.

```{r}
algae <- 
  read.csv("algae.csv")

head(algae)

algae$id <- as.factor(algae$id)
algae$size.cat <- as.factor(algae$size.cat)
algae$species <- as.factor(algae$species)
```

Now we make a new dataframe to work with and rename size categories.

```{r}
algae2 <- algae

algae2$size.cat <- factor(algae2$size.cat, 
                              levels=c("twentyto50", "fiftyto100",
                                       "onehundredto500", "fivehundredto1000", 
                                       "onethousandto5000"))  # reorder


algae2$size.cat <- mapvalues(algae2$size.cat, 
                                 from = c("twentyto50", "fiftyto100", 
                                          "onehundredto500", 
                                          "fivehundredto1000", 
                                          "onethousandto5000"), 
                                 to = c("20-50", "50-100", "100-500",
                                        "500-1000", "1000-5000"))  # rename
summary(algae2$size.cat)  # view
```

Again, we melt the dataframe so that the particle types are organized by row instead of by column.

```{r}
algae3 <- melt(algae2,
                   id.vars = c("id", "size.cat", "species"))

head(algae3)  # now "variable" is particle category and "value is the count"
```

Now sum by totals across all samples and particles sizes to get an idea of what we"re working with. First remove particles <100 microns as we don"t trust these counts.

```{r}
algae3 <- subset(algae3, size.cat != "20-50" & size.cat != "50-100")

algae3$size.cat <- as.character(algae3$size.cat)
algae3$size.cat <- as.factor(algae3$size.cat)

cat.sums.blanks <- aggregate(algae3$value ~ 
                               algae3$variable, FUN = sum)  # sums everything
print(cat.sums.blanks)
```

So we can remove the yellow, green, purple, gray, pink, brown, orange, and black fibre categories, and all other categories as well.

```{r}
algae4 <- subset(algae3, c(variable == "red.fib" | 
                             variable == "turq.fib" |
                             variable == "blu.fib" |
                             variable == "clear.fib"))  # keep only these rows

algae4$variable <- as.character(algae4$variable)
algae4$variable <- as.factor(algae4$variable)  # gets rid of those names

summary(algae4$variable)  # view
```

Let"s make the category names a bit more useful for plotting

```{r}
algae4$variable <- mapvalues(algae4$variable,
                                 from = c(levels(algae4$variable)), 
                                 to = c("Blue fibres", "Clear fibres", 
                                        "Red fibres", "Turquoise fibres"))

## And reorder them
algae4$variable <- factor(algae4$variable, 
                              levels = c("Blue fibres", "Clear fibres",
                                         "Red fibres", "Turquoise fibres"))

summary(algae4$variable)
```

## Adjusted algae data

Now subtract the blank counts from the appropriate size and shape categories for the algae counts.

```{r}
algae5 <-
  left_join(algae4, waterblanksmean, 
            by = c("size.cat", "variable")) ## Join the 2 dataframes

algae5$value.b <- as.numeric(algae5$value.b)
algae5$value.b[is.na(algae5$value.b)] <- 0

algae5$variable <- as.factor(algae5$variable)

algae5$finalcount <- (algae5$value - algae5$value.b)

algae5$finalcount[algae5$finalcount < 0] <-
  0 ## Change any negative values to 0

summary(algae5$finalcount)
```

Now plot particle size proportions for algae.

```{r}
## First we need to make a new data frame of sums according to each size category

algaesizesums <- 
  ddply(algae5, 
        c("id", "size.cat", "species"), 
        summarize, sum = sum(finalcount))



## Now calculate proportions of each particle size category

algaeprop <- ddply(algaesizesums,
                   c("size.cat", "species"), 
                   summarize, 
                   sum = sum(sum))

for(i in 1:nrow(algaeprop)) {
  algaeprop$prop[i] <-
    (algaeprop$sum[i] /
       sum(algaeprop$sum[algaeprop$species == algaeprop$species[i]]))
}

algaeprop$size.cat <- as.character(algaeprop$size.cat)
algaeprop$size.cat <- as.factor(algaeprop$size.cat)

## Put the size categories in order

algaeprop$size.cat <- factor(algaeprop$size.cat, 
                                  levels = c("100-500", "500-1000", 
                                             "1000-5000"))

## Now plot

ggplot(algaeprop, aes(x=species, y=100*prop, fill = size.cat)) + 
  geom_col(size = 1, colour = "black") + 
  xlab("") + 
  ylab("Average percent") +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c("grey25", "grey50", "grey75")) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12,
                                   face = "italic"),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = c(0,0)) + 
  scale_y_continuous(expand = c(0.03,0))

```

Now with particle type/colour

```{r}
## First we need to make a new data frame of sums according to each particle
## type/colour

algaetypesums <- 
  ddply(algae5, 
        c("id", 
          "variable",
          "species"),
        summarize, sum = sum(finalcount))



## Now calculate proportions of each particle type/colour present in each 
## sample and take the means for each sampling day

algaetypeprop <- ddply(algaetypesums,
                        c("variable",
                          "species"), 
                        summarize, 
                        sum = sum(sum))
algaetypeprop$prop <- numeric(length = nrow(algaetypeprop))

for(i in 1:nrow(algaetypeprop)) {
  algaetypeprop$prop[i] <-
    (algaetypeprop$sum[i] /
       sum(algaetypeprop$sum[algaetypeprop$species == 
                               algaetypeprop$species[i]]))
}

watertypeprop$variable <- as.character(watertypeprop$variable)
watertypeprop$variable <- as.factor(watertypeprop$variable)

## Now plot

ggplot(algaetypeprop, aes(x=species, y=100*prop, fill = variable)) + 
  geom_col(size = 0.5, colour = "black") + 
  xlab("") + 
  ylab("Average percent") +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c("steel blue", "grey90", "red", "turquoise")) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12,
                                   face = "italic"),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = c(0,0)) + 
  scale_y_continuous(expand = c(0.03,0))

```

Take total sums and plot the results.

```{r}
totalalgaesums <- ddply(algae5, 
                        c("id", "species"),
                        summarise, sum = sum(finalcount))  # adds all the counts together

## Plot according to count per filtration day

ggplot(totalalgaesums, aes(x=species, y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab("Species") +
  ylab(expression(paste("# AFs 500"~mL^-1))) +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12,
                                   face = "italic"),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

Now run the same summary stats for the algae samples.

```{r}
## medians, range, and SD

with(totalalgaesums, tapply(sum, species, median))  # takes median for each species
with(totalalgaesums, tapply(sum, species, min))  # takes minimum for each species
with(totalalgaesums, tapply(sum, species, max))  # takes maximum for each species
with(totalalgaesums, tapply(sum, 
                       species, sd))  # takes standard deviation for each species

## Proportions of particles sizes

sum(algae5$finalcount[algae5$size.cat == "100-500"])/
  sum(algae5$finalcount)*100

sum(algae5$finalcount[algae5$size.cat == "500-1000"])/
  sum(algae5$finalcount)*100

sum(algae5$finalcount[algae5$size.cat == "1000-5000"])/
  sum(algae5$finalcount)*100

## This provides the percentage of total particles found accounted for by each 
## colour/type of particles
algaesummarytable <- with(algae5, tapply(value, variable, sum))
algaesummarytable <- algaesummarytable/sum(algae5$finalcount)*100
print(algaesummarytable)
```

## Oyster statistics

Now fit a generalized linear mixed model (GLMM) to the oyster data using the package glmmTMB to determine differences over time. We"ll specify AF count as the response variable, sampling day as the predictor, and tank nested within table as the random, or mixed, effects. You"ll notice that sample day is specified twice. The second time is to set it up as the intercept for the random effect, which will allow the linear relationship between AP sum and sampling day to vary in both slope and intercept according separately within each tank, within each table. This accounts for any the variation that may have been caused by any variables that we did not account for and may have varied somehow in different tanks and or/tables.

```{r}
# Gaussian

totalsums$sampleday <- as.character(totalsums$sampleday)
totalsums$sampleday <- as.numeric(totalsums$sampleday)

M1 <- 
  glmmTMB(log(sum + 1) ~ sampleday + length + (1 | Table/Tank),
          data = totalsums) ## Fits a GLMM

summary(M1) # model output

res1 <- simulateResiduals(M1)

plot(res1)

plot(resid(M1) ~ fitted(M1))
abline(0,0)
```

Sample day significant (p<0.001), oyster length not significant (p = 0.0787).

## Plot model predictions

```{r}
predictions <- 
  data.frame(sampleday = seq(from = 0,
                              to = 10,
                              length.out = 1000),
             length = with(totalsums,
                           sample(c(min(length),
                                    median(length),
                                    max(length)),
                                  1000,
                                  replace = TRUE)),
             Table = rep(NA, 1000),
             Tank = rep(NA, 1000))

new.predict <-
  predict(M1,
          newdata = predictions,
          re.form = NA,
          type = "link",
          se.fit = TRUE)

predictions$mean <- exp(new.predict$fit) - 1
predictions$upper <- exp(with(new.predict, fit + 1.96*se.fit)) - 1
predictions$lower <- exp(with(new.predict, fit - 1.96*se.fit)) - 1

predictions$length <- as.factor(predictions$length)

ggplot() +
  geom_ribbon(data = predictions,
              aes(x = sampleday,
                  ymin = lower,
                  ymax = upper,
                  fill = length),
              alpha = 0.5) +
  geom_line(data = predictions,
            aes(x = sampleday,
                y = mean,
                colour = length),
            size = 1) +
  geom_point(data = totalsums,
             aes(x = sampleday,
                 y = sum),
             size = 0.75) +
  scale_colour_brewer(type = "qual",
                      palette = "Set2",
                      name = "Length (mm)") +

  scale_fill_brewer(type = "qual",
                    palette = "Set2",
                    name = "Length (mm)") +
  labs(x = "Day",
       y = "Number of anthropogenic particles") +
  theme1
```










Run tests to determine whether there were significant differences in AP size according to day.

```{r}
SM1 <- glmmTMB(prop ~ size.cat*sampleday + (1 | Table/Tank), family = binomial, 
               data = oysterprop5)
summary(SM1)
plot(resid(SM1) ~ fitted(SM1))

SM5 <- glmmTMB(prop ~ size.cat + sampleday + (1 | Table/Tank), family = binomial, 
               data = oysterprop5)

anova(SM1, SM5)  # interaction is signficant at p = 0.04

ggplot(oysterprop5) +
  geom_violin(aes(x = sampleday, y = prop)) +
  facet_wrap(~ size.cat)
```
