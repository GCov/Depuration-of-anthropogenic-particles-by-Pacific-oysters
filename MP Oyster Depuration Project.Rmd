---
title: "MP Oyster Depuration Project"
author: "Garth C"
date: "January 9, 2018"
output: word_document
---

Load the libraries we'll need. You'll have to install these if you don't already have them.

```{r}
library(plyr)
library(reshape2)
library(ggplot2)
library(glmmTMB)
library(MuMIn)
```

## Load, organize, and plot data

Import the oyster depuration data and view it.

```{r}
oysterdep <- 
  read.csv("oysterdep.csv")

head(oysterdep)
```

Get all of the variables into the right format.

```{r}
oysterdep$id <- as.factor(oysterdep$id)
oysterdep$sampleday <- as.factor(oysterdep$sampleday)
oysterdep$size.cat <- as.factor(oysterdep$size.cat)
oysterdep$Table <- as.factor(oysterdep$Table)
oysterdep$Tank <- as.factor(oysterdep$Tank)
oysterdep$observer <- as.factor(oysterdep$observer)
```

Make a new dataframe to work with and rename size categories.

```{r}
oysterdep2 <- oysterdep

oysterdep2$size.cat <- factor(oysterdep2$size.cat, 
                              levels=c('twentyto50', 'fiftyto100',
                                       'onehundredto500', 'fivehundredto1000', 
                                       'onethousandto5000'))  # reorder


oysterdep2$size.cat <- mapvalues(oysterdep2$size.cat, 
                                 from = c('twentyto50', 'fiftyto100', 
                                          'onehundredto500', 
                                          'fivehundredto1000', 
                                          'onethousandto5000'), 
                                 to = c('20-50', '50-100', '100-500',
                                        '500-1000', '1000-5000'))  # rename
summary(oysterdep2$size.cat)  # view
```

We need to melt the dataframe so that the particle types are organized by row instead of by column.

```{r}
oysterdep3 <- melt(oysterdep2,
                   id.vars = c('id', 'sampleday', 'size.cat', 'Table', 'Tank',
                               'species', 'DOFSample', 'length', 'width', 
                               'depth', 'cont.weight', 'cont.dryweight', 
                               'dry.weight', 'shell.dry.weight', 'CI',
                               'time.in.oven', 'time.out.oven',
                               'dat.filter', 'dat.count', 'observer'))

##  Take out unnecessary columns

oysterdep3 <- oysterdep3[c('id', 'sampleday', 'size.cat', 'Table', 'Tank', 
                         'DOFSample', 'length', 'width', 'depth', 'dry.weight',
                         'shell.dry.weight', 'CI', 'dat.filter', 'dat.count',
                         'observer', 'variable', 'value')]

head(oysterdep3)  # now 'variable' is particle category and 'value is the count'
```

Now we want to see what kind of particles we found and remove any categories that we didn't end up using.

```{r}
cat.sums <- aggregate(oysterdep3$value ~ 
                        oysterdep3$variable, FUN = sum)  # sums everything
print(cat.sums)
```

So we can remove the purple fibre, gray fibre, yellow fragment, purple fragment, gray fragment, brown fragment, orange fragment, and black fragment categories because we didn't count any of these.

```{r}
oysterdep4 <- subset(oysterdep3, 
                     variable != 'purp.fib' &
                       variable != 'gray.fib' &
                       variable != 'yell.frag' &
                       variable != 'turq.frag' &
                       variable != 'purp.frag' &
                       variable != 'gray.frag' &
                       variable != 'brown.frag' &
                       variable != 'orang.frag' &
                       variable != 'black.frag')  # removes all these rows

oysterdep4$variable <- as.character(oysterdep4$variable)
oysterdep4$variable <- as.factor(oysterdep4$variable)  # gets rid of those names

summary(oysterdep4$variable)  # view
```

Let's make the category names a bit more useful for plotting

```{r}
oysterdep4$variable <- mapvalues(oysterdep4$variable,
                                 from = c(levels(oysterdep4$variable)), 
                                 to = c('Black fibres', 
                                        'Blue fibres', 
                                        'Blue fragments',
                                        'Brown fibres', 
                                        'Clear fibres',
                                        'Clear fragments',
                                        'Clear spheres',
                                        'Green fibres',
                                        'Green fragments',
                                        'Orange fibres',
                                        'Pink fibres', 
                                        'Pink fragments',
                                        'Red fibres',
                                        'Red fragments',
                                        'Turquoise fibres', 
                                        'White spheres',
                                        'Yellow fibres'))

## And reorder them
oysterdep4$variable <- factor(oysterdep4$variable, 
                              levels = c('Black fibres', 
                                         'Blue fibres',
                                         'Brown fibres', 
                                         'Clear fibres',
                                         'Green fibres', 
                                         'Orange fibres',
                                         'Pink fibres', 
                                         'Red fibres',
                                         'Turquoise fibres',
                                         'Yellow fibres',
                                         'Blue fragments',
                                         'Clear fragments',
                                         'Green fragments',
                                         'Pink fragments',
                                         'Red fragments',
                                         'Clear spheres',
                                         'White spheres'))

summary(oysterdep4$variable)
```

Let's combine all size categories below 100 microns, since we weren't very confident in identifying these size classes so it makes more sense to pool them.

```{r}
oysterdep4$size.cat <-
  mapvalues(
    oysterdep4$size.cat,
    from = c('20-50', '50-100'),
    to = c('10-100', '10-100')
  )  ## pool <100 micron particles

oysterdep4 <- ddply(oysterdep4, names(oysterdep4)[-c(17)], summarize,
                   value = sum(value))
```

Next let's make plots of the distribution of sizes and particle types and colours.

Starting with size

```{r}
## First we need to make a new data frame of sums according to each size category

oystersizesums <- ddply(oysterdep4, c('id', 'sampleday', 'size.cat', 'Table', 
                                      'Tank', 'DOFSample', 'length', 'width',
                                      'depth', 'dry.weight', 'shell.dry.weight',
                                      'CI', 'dat.filter', 'dat.count', 
                                      'observer'), summarize, sum = sum(value))



## Now calculate proportions of each particle size category present in each 
## sample and take the means for each sampling day

oysterprop <- ddply(oystersizesums, 'id', transform, prop = sum/sum(sum))

oysterprop2 <- subset(oysterprop, !(is.na(oysterprop["prop"])))  # remove any NAs

oysterprop2$size.cat <- as.character(oysterprop2$size.cat)
oysterprop2$size.cat <- as.factor(oysterprop2$size.cat)

oysterprop3 <- ddply(oysterprop2, c("sampleday", "size.cat"), summarize,
                     mean = mean(prop))

## Put the size categories in order

oysterprop3$size.cat <- factor(oysterprop3$size.cat, 
                                  levels = c("10-100", 
                                             "100-500", 
                                             "500-1000", 
                                             "1000-5000"))

## Now plot

ggplot(oysterprop3, aes(x=sampleday, y=100*mean, fill = size.cat)) + 
  geom_col(size = 1, colour = 'black') + 
  xlab('Sampling Day') + 
  ylab('Average percent') +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c('grey0',
                               'grey25',
                               'grey50',
                               'grey75')) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = c(0,0.5)) + 
  scale_y_continuous(expand = c(0.03,0))

```

Now with particle type/colour

```{r}
## First we need to make a new data frame of sums according to each particle
## type/colour

oystertypesums <- ddply(oysterdep4, c('id', 'sampleday', 'Table', 
                                      'Tank', 'DOFSample', 'length', 'width',
                                      'depth', 'dry.weight', 'shell.dry.weight',
                                      'CI', 'dat.filter', 'dat.count', 
                                      'observer', 'variable'), summarize, 
                        sum = sum(value))



## Now calculate proportions of each particle type/colour present in each 
## sample and take the means for each sampling day

oystertypeprop <- ddply(oystertypesums, 'id', transform, prop = sum/sum(sum))

oystertypeprop2 <- subset(oystertypeprop, !(is.na(oystertypeprop["prop"])))  # remove any NAs

oystertypeprop2$variable <- as.character(oystertypeprop2$variable)
oystertypeprop2$variable <- as.factor(oystertypeprop2$variable)

oystertypeprop3 <- ddply(oystertypeprop2, c("sampleday", "variable"), summarize,
                     mean = mean(prop))

## Now plot

ggplot(oystertypeprop3, aes(x = sampleday, y = 100 * mean, fill = variable)) +
  geom_col(size = 0.5, colour = 'black') +
  xlab('Sampling Day') +
  ylab('Average percent') +
  guides(fill = guide_legend(title = "Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(
    values = c(
      'Grey16',
      'Steel Blue',
      'Navy',
      'Saddle Brown',
      'Grey50',
      'Grey75',
      'Grey90',
      'Forest Green',
      'Dark Green',
      'Orange',
      'Pink',
      'Hot Pink',
      'Red',
      'Red3',
      'Turquoise',
      'White',
      'Gold'
    )
  ) +
  theme(
    legend.text = element_text(size = 12),
    text = element_text(size = 12),
    panel.spacing = unit(1, "lines"),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12,
                               margin = margin(
                                 t = 0,
                                 r = 0,
                                 b = 0,
                                 l = 2
                               )),
    strip.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.placement = "outside"
  ) +
  scale_x_discrete(expand = expand_scale(0, 0.5)) +
  scale_y_continuous(expand = expand_scale(0.03, 0))

```

Take total sums overall and plot the results.

```{r}
totalsums <- ddply(oysterdep4, c('id', 'sampleday', 'Table', 'Tank', 
                                 'length', 'width', 'depth', 'dry.weight',
                                 'shell.dry.weight', 'CI', 'observer'),
                   summarise, sum = sum(value))  # adds all the counts together

## Plot according to count per individual

ggplot(totalsums, aes(x=sampleday , y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab('Day') + 
  coord_cartesian(ylim = c(0, 41)) +
  ylab('# APs') +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

## Plot according to concentration (particles/dry tissue weight)

ggplot(totalsums, aes(x=sampleday , y=sum/dry.weight)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab('Day') + 
  coord_cartesian(ylim = c(0, 20)) +
  ylab('# APs/g dry tissue') +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

Let's print out some summary stats.

```{r}
## Summary stats according to count per individual

with(totalsums, tapply(sum, sampleday, median))  # takes c for each day
with(totalsums, tapply(sum, sampleday, min))  # takes minimum for each day
with(totalsums, tapply(sum, sampleday, max))  # takes maximum for each day
with(totalsums, tapply(sum, 
                       sampleday, sd))  # takes standard deviation for each day

## Summary stats according to concentration

with(totalsums, tapply(sum/dry.weight, 
                       sampleday, median))  # takes median for each day
with(totalsums, tapply(sum/dry.weight, 
                       sampleday, min))  # takes minimum for each day
with(totalsums, tapply(sum/dry.weight, 
                       sampleday, max))  # takes maximum for each day
with(totalsums, tapply(sum, 
                       sampleday, sd))  # takes standard deviation for each day

## Proportions of particles sizes

sum(oysterdep4$value[oysterdep4$size.cat == '10-100'])/
  sum(oysterdep4$value)*100  

sum(oysterdep4$value[oysterdep4$size.cat == '100-500'])/
  sum(oysterdep4$value)*100  

sum(oysterdep4$value[oysterdep4$size.cat == '500-1000'])/
  sum(oysterdep4$value)*100 

sum(oysterdep4$value[oysterdep4$size.cat == '1000-5000'])/
  sum(oysterdep4$value)*100


## This provides the percentage of total particles found accounted for by each 
## colour/type of particles
oystersummarytable <- with(oysterdep4, tapply(value, variable, sum))
oystersummarytable <- oystersummarytable/sum(oysterdep4$value)*100
print(oystersummarytable)
```

### Blanks
Now load in the blanks dataset and set it up for plotting, same as with the oyster data set. First we load in the data.

```{r}
depblanks <- 
  read.csv("depblanks.csv")

head(depblanks)

depblanks$id <- as.factor(depblanks$id)
depblanks$size.cat <- as.factor(depblanks$size.cat)
depblanks$observer <- as.factor(depblanks$observer)
depblanks$sampleday <- as.factor(depblanks$sampleday)
```

Now we make a new dataframe to work with and rename size categories.

```{r}
depblanks2 <- depblanks

depblanks2$size.cat <- factor(depblanks2$size.cat, 
                              levels=c('twentyto50', 'fiftyto100',
                                       'onehundredto500', 'fivehundredto1000', 
                                       'onethousandto5000'))  # reorder


depblanks2$size.cat <- mapvalues(depblanks2$size.cat, 
                                 from = c('twentyto50', 'fiftyto100', 
                                          'onehundredto500', 
                                          'fivehundredto1000', 
                                          'onethousandto5000'), 
                                 to = c('20-50', '50-100', '100-500',
                                        '500-1000', '1000-5000'))  # rename
summary(depblanks2$size.cat)  # view
```

Again, we melt the dataframe so that the particle types are organized by row instead of by column.

```{r}
depblanks3 <- melt(depblanks2,
                   id.vars = c('id', 'size.cat', 'sampleday', 'DOFSample', 
                               'time.in.oven', 'time.out.oven', 'dat.filter', 
                               'dat.count', 'observer'))

##  Take out unnecessary columns

depblanks3 <- depblanks3[c('id', 'size.cat', 'sampleday', 'DOFSample', 
                           'dat.filter', 'dat.count', 'observer', 'variable', 
                           'value')]

head(depblanks3)  # now 'variable' is particle category and 'value is the count'
```

Now sum by totals across all samples and particles sizes to get an idea of what we're working with.

```{r}
cat.sums.blanks <- aggregate(depblanks3$value ~ 
                               depblanks3$variable, FUN = sum)  # sums everything
print(cat.sums.blanks)
```

So we can remove the red, yellow, green turquoise, purple, gray, brown, orange, and black fibre categories, and all non-fibre categories other than blue frags.

```{r}
depblanks4 <- subset(depblanks3, 
                     c(variable == 'blu.fib' | 
                         variable == 'clear.fib' | 
                         variable == 'pink.fib' |
                         variable == 'blu.frag')
                     )  # keep only these rows

depblanks4$variable <- as.character(depblanks4$variable)
depblanks4$variable <- as.factor(depblanks4$variable)  # gets rid of those names

summary(depblanks4$variable)  # view
```

Let's make the category names a bit more useful for plotting

```{r}
depblanks4$variable <- mapvalues(depblanks4$variable,
                                 from = c(levels(depblanks4$variable)), 
                                 to = c('Blue fibres',  
                                        'Blue fragments',
                                        'Clear fibres', 
                                        'Pink fibres'))

## And reorder them
depblanks4$variable <- factor(depblanks4$variable, 
                              levels = c('Blue fibres', 'Clear fibres',
                                         'Pink fibres', 'Blue fragments'))

summary(depblanks4$variable)
```

Let's combine all size categories below 100 microns, since we weren't very confident in identifying these size classesso it makes more sense to pool them.

```{r}
depblanks4$size.cat <-
  mapvalues(
    depblanks4$size.cat,
    from = c('20-50', '50-100'),
    to = c('10-100', '10-100')
  )  ## pool <100 micron particles

depblanks4 <- ddply(depblanks4, names(depblanks4)[-9], summarize,
                   value = sum(value))
```


Next let's make plots of the distribution of sizes and particle types and colours.

Starting with size

```{r}
## First we need to make a new data frame of sums according to each size category

blankssizesums <- ddply(depblanks4, c('id', 'size.cat', 'sampleday', 
                                      'DOFSample',  'dat.filter', 'dat.count', 
                                      'observer'), summarize, sum = sum(value))



## Now calculate proportions of each particle size category present in each 
## sample and take the means for each sampling day

blanksprop <- ddply(blankssizesums, c('id', 'sampleday'), transform, prop = sum/sum(sum))

blanksprop2 <- subset(blanksprop, !(is.na(blanksprop["prop"])))  # remove any NAs

blanksprop2$size.cat <- as.character(blanksprop2$size.cat)
blanksprop2$size.cat <- as.factor(blanksprop2$size.cat)

blanksprop3 <- ddply(blanksprop2, c("DOFSample", "sampleday", "size.cat"), summarize,
                     mean = mean(prop))

## Put the size categories in order

blanksprop3$size.cat <- factor(blanksprop3$size.cat, 
                                  levels = c("10-100", 
                                             "100-500", "500-1000", 
                                             "1000-5000"))

## Now plot

ggplot(blanksprop3, aes(x=sampleday, y=100*mean, fill = size.cat)) + 
  geom_col(size = 1, colour = 'black') + 
  xlab('Sampling Day') + 
  ylab('Average percent') +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c('grey0', 'grey25', 'grey50', 'grey75')) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = expand_scale(0,0.5)) + 
  scale_y_continuous(expand = expand_scale(0.03,0))

```

Now with particle type/colour

```{r}
## First we need to make a new data frame of sums according to each particle
## type/colour

blankstypesums <- ddply(depblanks4, c('id', 'sampleday', 'DOFSample', 
                                      'dat.filter', 'dat.count', 'observer', 
                                      'variable'), 
                        summarize, sum = sum(value))

## Now calculate proportions of each particle type/colour present in each 
## sample and take the means for each sampling day

blankstypeprop <- ddply(blankstypesums, c('id', 'sampleday'), transform, 
                        prop = sum/sum(sum))

blankstypeprop2 <- subset(blankstypeprop, !(is.na(blankstypeprop["prop"])))  # remove any NAs

blankstypeprop2$variable <- as.character(blankstypeprop2$variable)
blankstypeprop2$variable <- as.factor(blankstypeprop2$variable)

blankstypeprop3 <- ddply(blankstypeprop2, c("DOFSample", "sampleday", 
                                            "variable"), summarize,
                     mean = mean(prop))

## Now plot

ggplot(blankstypeprop3, aes(x=sampleday, y=100*mean, fill = variable)) + 
  geom_col(size = 0.5, colour = 'black') + 
  xlab('Sampling Day') + 
  ylab('Average percent') +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c('Steel Blue', 'Navy', 'Grey50', 'Pink')) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = expand_scale(0,0.5)) + 
  scale_y_continuous(expand = expand_scale(0.03,0))

```

Take total sums and plot the results.

```{r}
totalblanksums <- ddply(depblanks4, c('id', 'sampleday', 'observer', 
                                      'dat.filter', 'DOFSample'),
                   summarise, sum = sum(value))  # adds all the counts together

## Plot according to count per filtration day

ggplot(totalblanksums, aes(x=sampleday, y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab('Day') + 
  ylab('# APs') +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

Now do the same summary stats for the blanks

```{r}
## Means, range, and SD

with(totalblanksums, tapply(sum, DOFSample, mean))  # takes mean for each day
with(totalblanksums, tapply(sum, DOFSample, min))  # takes minimum for each day
with(totalblanksums, tapply(sum, DOFSample, max))  # takes maximum for each day
with(totalblanksums, tapply(sum, 
                       DOFSample, sd))  # takes standard deviation for each day

## Proportions of particles sizes

sum(depblanks4$value[depblanks4$size.cat == '10-100'])/
  sum(depblanks4$value)*100 

sum(depblanks4$value[depblanks4$size.cat == '100-500'])/
  sum(depblanks4$value)*100

sum(depblanks4$value[depblanks4$size.cat == '500-1000'])/
  sum(depblanks4$value)*100

sum(depblanks4$value[depblanks4$size.cat == '1000-5000'])/
  sum(depblanks4$value)*100

## This provides the percentage of total particles found accounted for by each 
## colour/type of particles
blanksummarytable <- with(depblanks4, tapply(value, variable, sum))
blanksummarytable <- blanksummarytable/sum(depblanks4$value)*100
print(blanksummarytable)
```

Now subtract the blank counts from the appropriate size and shape categories for the oyster counts.

```{r}
library(dplyr)

depblanksmean <- ddply(depblanks4, c('size.cat', 'sampleday', 'dat.filter', 
                                     'variable'),
                       summarize, value.b = mean(value))

depblanksmean$value.b <-
  ceiling(depblanksmean$value.b) ## Round all blank averages up to the nearest whole number

oysterdep5 <-
  left_join(oysterdep4, depblanksmean, 
            by = c('sampleday', 'size.cat', 'variable')) ## Join the 2 dataframes

oysterdep5$value.b <- as.numeric(oysterdep5$value.b)
oysterdep5$value.b[is.na(oysterdep5$value.b)] <- 0

oysterdep4$variable <- as.factor(oysterdep4$variable)

oysterdep5$finalcount <- (oysterdep5$value - oysterdep5$value.b)

oysterdep5$finalcount[oysterdep5$finalcount < 0] <-
  0 ## Change any negative values to 0

summary(oysterdep5$finalcount)

```

Now run all of the same code again but for the modified oyster counts.

```{r}
## First we need to make a new data frame of sums according to each size category

oystersizesums2 <- ddply(oysterdep5, c('id', 'sampleday', 'size.cat', 'Table', 
                                      'Tank', 'DOFSample', 'length', 'width',
                                      'depth', 'dry.weight', 'shell.dry.weight',
                                      'CI', 'dat.count', 
                                      'observer'), summarize, sum = sum(finalcount))



## Now calculate proportions of each particle size category present in each 
## sample and take the means for each sampling day

oysterprop4 <- ddply(oystersizesums2, 'id', transform, prop = sum/sum(sum))

oysterprop5 <- subset(oysterprop4, !(is.na(oysterprop4["prop"])))  # remove any NAs

oysterprop5$size.cat <- as.character(oysterprop5$size.cat)
oysterprop5$size.cat <- as.factor(oysterprop5$size.cat)

oysterprop6 <- ddply(oysterprop5, c("sampleday", "size.cat"), summarize,
                     mean = mean(prop))


## Now plot

ggplot(oysterprop6, aes(x=sampleday, y=100*mean, fill = size.cat)) + 
  geom_col(size = 1) + 
  xlab('Sampling Day') + 
  ylab('Average percent') +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c("#F0E442", "#009E73", 
                               "#56B4E9", "#0072B2", "black")) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = expand_scale(0,0.5)) + 
  scale_y_continuous(expand = expand_scale(0.03,0))

```

Now with particle type/colour

```{r}
## First we need to make a new data frame of sums according to each particle
## type/colour

oystertypesums2 <- ddply(oysterdep5, c('id', 'sampleday', 'Table', 
                                      'Tank', 'DOFSample', 'length', 'width',
                                      'depth', 'dry.weight', 'shell.dry.weight',
                                      'CI', 'dat.count', 
                                      'observer', 'variable'), summarize, 
                        sum = sum(finalcount))



## Now calculate proportions of each particle type/colour present in each 
## sample and take the means for each sampling day

oystertypeprop4 <- ddply(oystertypesums2, 'id', transform, prop = sum/sum(sum))

oystertypeprop5 <- subset(oystertypeprop4, !(is.na(oystertypeprop4["prop"])))  # remove any NAs

oystertypeprop5$variable <- as.character(oystertypeprop5$variable)
oystertypeprop5$variable <- as.factor(oystertypeprop5$variable)

oystertypeprop6 <- ddply(oystertypeprop5, c("sampleday", "variable"), summarize,
                     mean = mean(prop))

## Now plot

ggplot(oystertypeprop6, aes(x=sampleday, y=100*mean, fill = variable)) + 
  geom_col(size = 0.5, colour = 'black') + 
  xlab('Sampling Day') + 
  ylab('Average percent') +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c('black', 'blue', 'saddlebrown', 'grey90', 
                               'green4', 'orange',  'pink', 'red', 'turquoise', 
                               'yellow')) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = expand_scale(0,0.5)) + 
  scale_y_continuous(expand = expand_scale(0.03,0))

```

Take total sums overall and plot the results.

```{r}
totalsums2 <- ddply(oysterdep5, c('id', 'sampleday', 'Table', 'Tank', 
                                 'length', 'width', 'depth', 'dry.weight',
                                 'shell.dry.weight', 'CI', 'observer'),
                   summarise, sum = sum(finalcount))  # adds all the counts together

## Plot according to count per individual

ggplot(totalsums2, aes(x=sampleday , y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab('Day') + 
  coord_cartesian(ylim = c(0, 40)) +
  ylab('# AFs') +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

## Plot according to concentration (particles/dry tissue weight)

ggplot(totalsums2, aes(x=sampleday , y=sum/dry.weight)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab('Day') + 
  coord_cartesian(ylim = c(0, 15)) +
  ylab('# AFs/g dry tissue') +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

Let's print out some summary stats.

```{r}
## Summary stats according to count per individual

with(totalsums2, tapply(sum, sampleday, mean))  # takes mean for each day
with(totalsums2, tapply(sum, sampleday, min))  # takes minimum for each day
with(totalsums2, tapply(sum, sampleday, max))  # takes maximum for each day
with(totalsums2, tapply(sum, 
                       sampleday, sd))  # takes standard deviation for each day

## Summary stats according to concentration

with(totalsums2, tapply(sum/dry.weight, 
                       sampleday, mean))  # takes mean for each day
with(totalsums2, tapply(sum/dry.weight, 
                       sampleday, min))  # takes minimum for each day
with(totalsums2, tapply(sum/dry.weight, 
                       sampleday, max))  # takes maximum for each day
with(totalsums2, tapply(sum/dry.weight, 
                       sampleday, sd))  # takes standard deviation for each day

## Proportions of particles sizes

sum(oystersizesums2$sum[oystersizesums2$size.cat == '10-100'])/
  sum(oystersizesums2$sum)*100

sum(oystersizesums2$sum[oystersizesums2$size.cat == '100-500'])/
  sum(oystersizesums2$sum)*100

sum(oystersizesums2$sum[oystersizesums2$size.cat == '500-1000'])/
  sum(oystersizesums2$sum)*100

sum(oystersizesums2$sum[oystersizesums2$size.cat == '1000-5000'])/
  sum(oystersizesums2$sum)*100

## This provides the percentage of total particles found accounted for by each 
## colour/type of particles
oystersummarytable <- with(oystertypesums2, tapply(sum, variable, sum))
oystersummarytable <- oystersummarytable/sum(oystertypesums2$sum)*100
print(oystersummarytable)
```

Now load in the water sample data.

```{r}
depwater <- 
  read.csv("depwater.csv")

head(depwater)

depwater$id <- as.factor(depwater$id)
depwater$day <- as.factor(depwater$day)
depwater$size.cat <- as.factor(depwater$size.cat)
depwater$Table <- as.factor(depwater$Table)
depwater$Tank <- as.factor(depwater$Tank)
depwater$observer <- as.factor(depwater$observer)
```

Now we make a new dataframe to work with and rename size categories.

```{r}
depwater2 <- depwater

depwater2$size.cat <- factor(depwater2$size.cat, 
                              levels=c('twentyto50', 'fiftyto100',
                                       'onehundredto500', 'fivehundredto1000', 
                                       'onethousandto5000'))  # reorder


depwater2$size.cat <- mapvalues(depwater2$size.cat, 
                                 from = c('twentyto50', 'fiftyto100', 
                                          'onehundredto500', 
                                          'fivehundredto1000', 
                                          'onethousandto5000'), 
                                 to = c('20-50', '50-100', '100-500',
                                        '500-1000', '1000-5000'))  # rename
summary(depwater2$size.cat)  # view
```

Again, we melt the dataframe so that the particle types are organized by row instead of by column.

```{r}
depwater3 <- melt(depwater2,
                   id.vars = c('id', 'day', 'size.cat', 'Table', 'Tank', 
                               'DOFSample', 'time.in.oven', 'time.out.oven', 
                               'dat.filter',  'dat.count', 'observer'))

##  Take out unnecessary columns

depwater3 <- depwater3[c('id', 'day', 'size.cat', 'Table', 'Tank', 'DOFSample', 
                         'dat.filter', 'dat.count', 'observer', 'variable', 
                         'value')]

head(depwater3)  # now 'variable' is particle category and 'value is the count'
```

Now sum by totals across all samples and particles sizes to get an idea of what we're working with.

```{r}
cat.sums.blanks <- aggregate(depwater3$value ~ 
                               depwater3$variable, FUN = sum)  # sums everything
print(cat.sums.blanks)
```

So we can remove the yellow, green, purple, gray, pink, brown, orange, and black fibre categories, and all other categories as well.

```{r}
depwater4 <- subset(depwater3, c(variable == 'red.fib' | 
                       variable == 'turq.fib' | variable == 'blu.fib' |
                       variable == 'clear.fib'))  # keep only these rows

depwater4$variable <- as.character(depwater4$variable)
depwater4$variable <- as.factor(depwater4$variable)  # gets rid of those names

summary(depwater4$variable)  # view
```

Let's make the category names a bit more useful for plotting

```{r}
depwater4$variable <- mapvalues(depwater4$variable,
                                 from = c(levels(depwater4$variable)), 
                                 to = c('Blue fibres', 'Clear fibres', 
                                        'Red fibres', 'Turquoise fibres'))

## And reorder them
depwater4$variable <- factor(depwater4$variable, 
                              levels = c('Blue fibres', 'Clear fibres',
                                         'Red fibres', 'Turquoise fibres'))

summary(depwater4$variable)
```

Let's combine all size categories below 100 microns, since we weren't very confident in identifying these size classesso it makes more sense to pool them.

```{r}
depwater4$size.cat <-
  mapvalues(
    depwater4$size.cat,
    from = c('20-50', '50-100'),
    to = c('10-100', '10-100')
  )  ## pool <100 micron particles

depwater4 <- ddply(depwater4, names(depwater4)[-11], summarize,
                   value = sum(value))
```

Now do all these same things for the water blanks.

```{r}
waterblanks <- 
  read.csv("~/GRAD school/ACRDP/Depuration/Data/Analysis/waterblanks.csv")

head(waterblanks)

waterblanks$id <- as.factor(waterblanks$id)
waterblanks$day <- as.factor(waterblanks$day)
waterblanks$size.cat <- as.factor(waterblanks$size.cat)
waterblanks$Table <- as.factor(waterblanks$Table)
waterblanks$Tank <- as.factor(waterblanks$Tank)
waterblanks$observer <- as.factor(waterblanks$observer)
```

Now we make a new dataframe to work with and rename size categories.

```{r}
waterblanks2 <- waterblanks

waterblanks2$size.cat <- factor(waterblanks2$size.cat, 
                              levels=c('twentyto50', 'fiftyto100',
                                       'onehundredto500', 'fivehundredto1000', 
                                       'onethousandto5000'))  # reorder


waterblanks2$size.cat <- mapvalues(waterblanks2$size.cat, 
                                 from = c('twentyto50', 'fiftyto100', 
                                          'onehundredto500', 
                                          'fivehundredto1000', 
                                          'onethousandto5000'), 
                                 to = c('20-50', '50-100', '100-500',
                                        '500-1000', '1000-5000'))  # rename
summary(waterblanks2$size.cat)  # view
```

Again, we melt the dataframe so that the particle types are organized by row instead of by column.

```{r}
waterblanks3 <- melt(waterblanks2,
                   id.vars = c('id', 'day', 'size.cat', 'Table', 'Tank', 
                               'DOFSample', 'time.in.oven', 'time.out.oven', 
                               'dat.filter',  'dat.count', 'observer'))

##  Take out unnecessary columns

waterblanks3 <- waterblanks3[c('id', 'day', 'size.cat', 'Table', 'Tank', 'DOFSample', 
                         'dat.filter', 'dat.count', 'observer', 'variable', 
                         'value')]

head(waterblanks3)  # now 'variable' is particle category and 'value is the count'
```

Now sum by totals across all samples and particles sizes to get an idea of what we're working with.

```{r}
cat.sums.blanks <- aggregate(waterblanks3$value ~ 
                               waterblanks3$variable, FUN = sum)  # sums everything
print(cat.sums.blanks)
```

So we can remove the red, yellow, green, turquoise, purple, gray, clear, pink, brown, orange, and black fibre categories, and all other categories as well.

```{r}
waterblanks4 <- subset(waterblanks3, variable == 'blu.fib')  # keep only these rows

waterblanks4$variable <- as.character(waterblanks4$variable)
waterblanks4$variable <- as.factor(waterblanks4$variable)  # gets rid of those names

summary(waterblanks4$variable)  # view
```

Let's make the category names a bit more useful for plotting

```{r}
waterblanks4$variable <- mapvalues(waterblanks4$variable,
                                 from = c(levels(waterblanks4$variable)), 
                                 to = 'Blue fibres')

summary(waterblanks4$variable)
```

Let's combine all size categories below 100 microns, since we weren't very confident in identifying these size classesso it makes more sense to pool them.

```{r}
waterblanks4$size.cat <-
  mapvalues(
    waterblanks4$size.cat,
    from = c('20-50', '50-100'),
    to = c('10-100', '10-100')
  )  ## pool <100 micron particles

waterblanks4 <- ddply(waterblanks4, names(waterblanks4)[-11], summarize,
                   value = sum(value))
```


Now subtract the blank counts from the appropriate size and shape categories for the water counts.

```{r}
depwater4$dat.filter <- as.factor(depwater4$dat.filter)
waterblanks4$dat.filter <- as.factor(waterblanks4$dat.filter)

waterblanksmean <- ddply(waterblanks4, c('size.cat', 'dat.filter', 
                                     'variable'),
                       summarize, value.b = mean(value))

depwater5 <-
  left_join(depwater4, waterblanksmean, 
            by = c('dat.filter', 'size.cat', 'variable')) ## Join the 2 dataframes

depwater5$value.b <- as.numeric(depwater5$value.b)
depwater5$value.b[is.na(depwater5$value.b)] <- 0

depwater5$variable <- as.factor(depwater5$variable)

depwater5$finalcount <- (depwater5$value - depwater5$value.b)

depwater5$finalcount[depwater5$finalcount < 0] <-
  0 ## Change any negative values to 0

summary(depwater5$finalcount)
```


```{r}
## First we need to make a new data frame of sums according to each size category

depwater5$day <- factor(depwater5$day, 
                        levels = 
                          c('0', '1', '3', '5', '10'))  # put in order

watersizesums <- ddply(depwater5, c('id', 'day', 'size.cat', 'Table', 'Tank', 
                                    'DOFSample', 'dat.filter', 'dat.count', 
                                      'observer'), summarize, sum = sum(finalcount))



## Now calculate proportions of each particle size category present in each 
## sample and take the means for each sampling day

waterprop <- ddply(watersizesums, 'id', transform, prop = sum/sum(sum))

waterprop2 <- subset(waterprop, !(is.na(waterprop["prop"])))  # remove any NAs

waterprop2$size.cat <- as.character(waterprop2$size.cat)
waterprop2$size.cat <- as.factor(waterprop2$size.cat)

waterprop3 <- ddply(waterprop2, c("day", "size.cat"), summarize,
                     mean = mean(prop))

## Put the size categories in order

waterprop3$size.cat <- factor(waterprop3$size.cat, 
                                  levels = c("10-100", "100-500", "500-1000", 
                                             "1000-5000"))

## Now plot

ggplot(waterprop3, aes(x=day, y=100*mean, fill = size.cat)) + 
  geom_col(size = 1) + 
  xlab('Sampling Day') + 
  ylab('Average percent') +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c("#009E73", "#56B4E9", "#0072B2", "black")) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = expand_scale(0,0.5)) + 
  scale_y_continuous(expand = expand_scale(0.03,0))

```

Now with particle type/colour

```{r}
## First we need to make a new data frame of sums according to each particle
## type/colour

watertypesums <- ddply(depwater5, c('id', 'day', 'Table', 'Tank', 
                                    'DOFSample', 'dat.filter', 'dat.count', 
                                    'observer', 'variable'), 
                        summarize, sum = sum(finalcount))



## Now calculate proportions of each particle type/colour present in each 
## sample and take the means for each sampling day

watertypeprop <- ddply(watertypesums, 'id', transform, prop = sum/sum(sum))

watertypeprop2 <- subset(watertypeprop, !(is.na(watertypeprop["prop"])))  # remove any NAs

watertypeprop2$variable <- as.character(watertypeprop2$variable)
watertypeprop2$variable <- as.factor(watertypeprop2$variable)

watertypeprop3 <- ddply(watertypeprop2, c("day", "variable"), summarize,
                     mean = mean(prop))

## Now plot

ggplot(watertypeprop3, aes(x=day, y=100*mean, fill = variable)) + 
  geom_col(size = 0.5, colour = 'black') + 
  xlab('Sampling Day') + 
  ylab('Average percent') +
  guides(fill=guide_legend(title="Particle size category \n (microns)")) +
  theme_bw() +
  scale_fill_manual(values = c('blue', 'grey90', 'red', 'turquoise')) +
  theme(legend.text = element_text(size=12), text = element_text(size=12), 
        panel.spacing = unit(1, "lines"),  
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12, 
                                   margin = margin(t=0, r=0, b=0, l=2)),
        strip.background = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.placement = "outside") +
  scale_x_discrete(expand = expand_scale(0,0.5)) + 
  scale_y_continuous(expand = expand_scale(0.03,0))

```

Take total sums and plot the results.

```{r}
totalwatersums <- ddply(depwater5, c('id', 'day', 'Table', 'Tank', 'observer', 
                                     'dat.filter'),
                   summarise, sum = sum(finalcount))  # adds all the counts together

## Plot according to count per filtration day

ggplot(totalwatersums, aes(x=day, y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab('Day') +
  ylab('# AFs') +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

Now run the same summary stats for the water samples.

```{r}
## Means, range, and SD

with(totalwatersums, tapply(sum, day, mean))  # takes mean for each day
with(totalwatersums, tapply(sum, day, min))  # takes minimum for each day
with(totalwatersums, tapply(sum, day, max))  # takes maximum for each day
with(totalwatersums, tapply(sum, 
                       day, sd))  # takes standard deviation for each day

## Proportions of particles sizes

sum(depwater4$value[depwater4$size.cat == '10-100'])/
  sum(depwater4$value)*100

sum(depwater4$value[depwater4$size.cat == '100-500'])/
  sum(depwater4$value)*100

sum(depwater4$value[depwater4$size.cat == '500-1000'])/
  sum(depwater4$value)*100

sum(depwater4$value[depwater4$size.cat == '1000-5000'])/
  sum(depwater4$value)*100

## This provides the percentage of total particles found accounted for by each 
## colour/type of particles
watersummarytable <- with(depwater4, tapply(value, variable, sum))
watersummarytable <- watersummarytable/sum(depwater4$value)*100
print(watersummarytable)
```

## MODELLING
Now fit a generalized linear mixed model (GLMM) to the oyster data using the package glmmTMB to determine differences over time. We'll specify AF count as the response variable, sampling day as the predictor, and tank nested within table as the random, or mixed, effects. You'll notice that sample day is specified twice. The second time is to set it up as the intercept for the random effect, which will allow the linear relationship between AP sum and sampling day to vary in both slope and intercept according separately within each tank, within each table. This accounts for any the variation that may have been caused by any variables that we did not account for and may have varied somehow in different tanks and or/tables.

```{r}
M1 <- glmmTMB(sum ~ sampleday + dry.weight + (1 | Table/Tank), 
              family = genpois(link = 'log'), 
              data = totalsums2) ## Fits a GLMM

summary(M1) # model output
plot(resid(M1) ~ fitted(M1)) # plot residuals vs. fitted
abline(0,0)
plot(resid(M1) ~ totalsums$sampleday) # plot residuals vs. predictor
```

Looking at the plot of residuals vs. fitted and residuals vs. sample day, we can see that the variance of the residuals varies according to the AP count and the sampling day. This violates the assumption of homogeneity of variance.

Let's try fitting the same model structure, but assuming that the response variable (AF count) varies at each value of x (sampling day) according to a negative binomial distribution.

```{r}
M2 <- glmmTMB(sum ~ sampleday + dry.weight + (1 | Table/Tank), 
              family = nbinom2(link = 'log'),
               data = totalsums2) ## Fits a NB GLMM

summary(M2) # model output
plot(resid(M2) ~ fitted(M2)) # plot residuals vs. fitted
plot(resid(M2) ~ totalsums$sampleday) # plot residuals vs. predictor

## Can compare M1 and M2 using AICc

AICc(M1, M2) 
# the negative binomial model with quadratically increasing variance is a better fit
```

The negative binomial model, which assumes that the variance of AF concentration increases quadratically with day of sampling, is a better fit.

Now let's try pulling out the predictor (sampling day) and using the anova() function to compare the first model with the null models to determine whether sampling day significantly predicts AP concentration.

```{r}
M3 <- glmmTMB(sum ~ dry.weight + (1 | Table/Tank), family = nbinom2(link = 'log'), 
               data = totalsums2) ## Same structure except no effect of day

M4 <- glmmTMB(sum ~ sampleday + (1 | Table/Tank), family = nbinom2(link = 'log'), 
               data = totalsums2) ## Same structure except no effect of dry.weight

anova(M2, M3)  # day is significant, p < 0.001
anova(M2, M4)  # dry weight is not significant, p = 0.54
AICc(M2, M4)  # better fit without dry weight, so go with M4

M5 <- glmmTMB(sum ~ (1 | Table/Tank), family = nbinom2(link = 'log'), 
               data = totalsums2) ## Null model
anova(M4, M5)  # sample day significant, p < 0.001
```

Sampling day is significant with a p-value of <0.001. We can now go into the model to determine which days are significantly different from each other. Looking back at the summary of M1 we can see that the AP concentrations at days 5 and 10 are both significantly different from day 0 (the reference level).

Now we reorder the levels in sample day to vary the reference level and figure out which days are significantly different from which other days.

```{r}
totalsums2$sampleday <- relevel(totalsums2$sampleday, '1')
M5 <- glmmTMB(sum ~ sampleday + (1 | Table/Tank), family = nbinom2(), 
               data = totalsums2) ## Fits a NB GLMM

summary(M2) # model output
```

Similarly, days 5 and 10 are significantly different from day 1.

```{r}
totalsums2$sampleday <- relevel(totalsums2$sampleday, '3')
M5 <- glmmTMB(sum ~ sampleday + (1 | Table/Tank), family = nbinom2(), 
               data = totalsums2) ## Fits a NB GLMM

summary(M5) # model output
```

Days 5 and 10 are significantly different from day 3.

```{r}
totalsums2$sampleday <- relevel(totalsums2$sampleday, '5')
M5 <- glmmTMB(sum ~ sampleday + (1 | Table/Tank), family = nbinom2(), 
               data = totalsums2) ## Fits a NB GLMM

summary(M5) # model output
```

Day 10 is the only day not significantly different from day 5.

So in summary:

Day | 0 | 1 | 3 | 5 | 10
----|---|---|---|---|-----
0   | x | - | - |sig| sig 
----|---|---|---|---|-----
1   | x | x | - |sig| sig
----|---|---|---|---|-----
3   | x | x | x |sig| sig
----|---|---|---|---|-----
5   | x | x | x | x | -
----|---|---|---|---|-----
10  | x | x | x | x | x

Now let's replot the data with letters used to indicate which days are significantly different from one another. Those with different letters are statistically different.

```{r}

## First we have to get the days back in the right order

totalsums2$sampleday <- factor(totalsums2$sampleday, 
                              levels = c("0","1","3","5", "10"))

## Now plot

ggplot(totalsums2, aes(x=sampleday , y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab('Day') + 
  coord_cartesian(ylim = c(0, 35)) +
  ylab('# AFs') +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  annotate("text", x=1, y=27, label = "A") + 
  annotate("text", x=2, y=30, label = "A") +
  annotate("text", x=3, y=25, label = "A") +
  annotate("text", x=4, y=7, label = "B") +
  annotate("text", x=5, y=12, label = "B")
```

Run tests to determine whether there were significant differences in AP size according to day.

```{r}
SM1 <- glmmTMB(prop ~ size.cat*sampleday + (1 | Table/Tank), family = binomial, 
               data = oysterprop5)
summary(SM1)
plot(resid(SM1) ~ fitted(SM1))

SM5 <- glmmTMB(prop ~ size.cat + sampleday + (1 | Table/Tank), family = binomial, 
               data = oysterprop5)

anova(SM1, SM5)  # interaction is signficant at p = 0.04

ggplot(oysterprop5) +
  geom_violin(aes(x = sampleday, y = prop)) +
  facet_wrap(~ size.cat)
```
