---
title: "MP Oyster Depuration Project"
author: "Garth C"
date: "January 9, 2018"
output: html_document
---

Load the libraries we'll need. You'll have to install these if you don't already have them.

```{r}
library(plyr)
library(reshape2)
library(ggplot2)
library(glmmADMB)
library(MuMIn)
```

## Load, organize, and plot data

Import the oyster depuration data and view it.

```{r}
oysterdep <- 
  read.csv("~/GRAD school/ACRDP/Depuration/Data/Analysis/R code/oysterdep.csv")

head(oysterdep)
```

Get all of the variables into the right format.

```{r}
oysterdep$id <- as.factor(oysterdep$id)
oysterdep$sampleday <- as.factor(oysterdep$sampleday)
oysterdep$size.cat <- as.factor(oysterdep$size.cat)
oysterdep$Table <- as.factor(oysterdep$Table)
oysterdep$Tank <- as.factor(oysterdep$Tank)
oysterdep$observer <- as.factor(oysterdep$observer)
```

Make a new dataframe to work with and rename size categories.

```{r}
oysterdep2 <- oysterdep

oysterdep2$size.cat <- factor(oysterdep2$size.cat, 
                              levels=c('twentyto50', 'fiftyto100',
                                       'onehundredto500', 'fivehundredto1000', 
                                       'onethousandto5000'))  # reorder


oysterdep2$size.cat <- mapvalues(oysterdep2$size.cat, 
                                 from = c('twentyto50', 'fiftyto100', 
                                          'onehundredto500', 
                                          'fivehundredto1000', 
                                          'onethousandto5000'), 
                                 to = c('20-50', '50-100', '100-500',
                                        '500-1000', '1000-5000'))  # rename
summary(oysterdep2$size.cat)  # view
```

We need to melt the dataframe so that the particle types are organized by row instead of by column.

```{r}
oysterdep3 <- melt(oysterdep2,
                   id.vars = c('id', 'sampleday', 'size.cat', 'Table', 'Tank',
                               'species', 'DOFSample', 'length', 'width', 
                               'depth', 'cont.weight', 'cont.dryweight', 
                               'dry.weight', 'shell.dry.weight', 'CI',
                               'time.in.oven', 'time.out.oven',
                               'dat.filter', 'dat.count', 'observer'))

##  Take out unnecessary columns

oysterdep3 <- oysterdep3[c('id', 'sampleday', 'size.cat', 'Table', 'Tank', 
                         'DOFSample', 'length', 'width', 'depth', 'dry.weight',
                         'shell.dry.weight', 'CI', 'dat.filter', 'dat.count',
                         'observer', 'variable', 'value')]

head(oysterdep3)  # now 'variable' is particle category and 'value is the count'
```

Now we want to see what kind of particles we found and remove any categories that we didn't end up using.

```{r}
cat.sums <- aggregate(oysterdep3$value ~ 
                        oysterdep3$variable, FUN = sum)  # sums everything
print(cat.sums)
```

So we can remove the purple fibre, gray fibre, yellow fragment, purple fragment, gray fragment, brown fragment, orange fragment, and black fragment categories because we didn't count any of these.

```{r}
oysterdep4 <- subset(oysterdep3, variable != 'purp.fib' & 
                       variable != 'gray.fib' & variable != 'yell.frag' &
                       variable != 'purp.frag' & variable != 'gray.frag' & 
                       variable != 'brown.frag' & variable != 'orang.frab' &
                       variable != 'black.frag')  # removes all these rows

oysterdep4$variable <- as.character(oysterdep4$variable)
oysterdep4$variable <- as.factor(oysterdep4$variable)  # gets rid of those names

summary(oysterdep4$variable)  # view
```

Let's make the category names a bit more useful for plotting

```{r}
oysterdep4$variable <- mapvalues(oysterdep4$variable,
                                 from = c(levels(oysterdep4$variable)), 
                                 to = c('Black fibres', 'Blue fibres', 
                                 'Blue fragments', 'Brown fibres', 
                                 'Clear fibres', 'Clear fragments', 
                                 'Clear spherules', 'Green fibres',
                                 'Green fragments', 'Orange fibres',
                                 'Orange fragments', 'Pink fibres', 
                                 'Pink fragments', 'Red fibres',
                                 'Red fragments', 'Turquoise fibres', 
                                 'Turquoise fragments', 'White spherules', 
                                 'Yellow fibres'))

## And reorder them
oysterdep4$variable <- factor(oysterdep4$variable, 
                              levels = c('Black fibres', 'Blue fibres',
                                         'Brown fibres', 'Clear fibres',
                                         'Green fibres', 'Orange fibres',
                                         'Pink fibres', 'Red fibres',
                                         'Turquoise fibres',
                                         'Yellow fibres', 'Blue fragments',
                                         'Clear fragments', 'Green fragments',
                                         'Orange fragments', 'Pink fragments',
                                         'Red fragments', 'Turquoise fragments',
                                         'Clear spherules', 'White spherules'))

summary(oysterdep4$variable)
```

Take total sums and plot the results.

```{r}
totalsums <- ddply(oysterdep4, c('id', 'sampleday', 'Table', 'Tank', 
                                 'length', 'width', 'depth', 'dry.weight',
                                 'shell.dry.weight', 'CI', 'observer'),
                   summarise, sum = sum(value))  # adds all the counts together

## Plot according to count per individual

ggplot(totalsums, aes(x=sampleday , y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab('Day') + 
  coord_cartesian(ylim = c(0, 41)) +
  ylab('# APs') +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

## Plot according to concentration (particles/dry tissue weight)

ggplot(totalsums, aes(x=sampleday , y=sum/dry.weight)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab('Day') + 
  coord_cartesian(ylim = c(0, 20)) +
  ylab('# APs/g dry tissue') +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

Let's print out some summary stats.

```{r}
## Summary stats according to count per individual

with(totalsums, tapply(sum, sampleday, mean))  # takes mean for each day
with(totalsums, tapply(sum, sampleday, min))  # takes minimum for each day
with(totalsums, tapply(sum, sampleday, max))  # takes maximum for each day
with(totalsums, tapply(sum, 
                       sampleday, sd))  # takes standard deviation for each day

## Summary stats according to concentration

with(totalsums, tapply(sum/dry.weight, 
                       sampleday, mean))  # takes mean for each day
with(totalsums, tapply(sum/dry.weight, 
                       sampleday, min))  # takes minimum for each day
with(totalsums, tapply(sum/dry.weight, 
                       sampleday, max))  # takes maximum for each day
with(totalsums, tapply(sum, 
                       sampleday, sd))  # takes standard deviation for each day

## Proportions of particles sizes

sum(oysterdep4$value[oysterdep4$size.cat == '10-20'])/
  sum(oysterdep4$value)*100  # 0%

sum(oysterdep4$value[oysterdep4$size.cat == '20-50'])/
  sum(oysterdep4$value)*100  # 0.55 %

sum(oysterdep4$value[oysterdep4$size.cat == '50-100'])/
  sum(oysterdep4$value)*100  # 3.09 %

sum(oysterdep4$value[oysterdep4$size.cat == '100-500'])/
  sum(oysterdep4$value)*100  # 41.82 %

sum(oysterdep4$value[oysterdep4$size.cat == '500-1000'])/
  sum(oysterdep4$value)*100  # 28.00 %

sum(oysterdep4$value[oysterdep4$size.cat == '1000-5000'])/
  sum(oysterdep4$value)*100  # 26.55 %


## Sums by particle type

summary(oysterdep4$variable)

sum(oysterdep4$value[oysterdep4$variable == 'Blue fragments' | 
                  oysterdep4$variable == 'Clear fragments' |
                  oysterdep4$variable == 'Green fragments' | 
                  oysterdep4$variable == 'Orange fragments' |
                  oysterdep4$variable == 'Pink fragments' |
                  oysterdep4$variable == 'Red fragments' |
                  oysterdep4$variable == 'Turquoise fragments'])/
  sum(oysterdep4$value) * 100

sum(oysterdep4$value[oysterdep4$variable == 'Clear spherules' | 
                  oysterdep4$variable == 'White spherules'])/
  sum(oysterdep4$value) * 100


## 1.45% fragments
## 1.27% spherules
## 97.28% fibres

## This provides the percentage of total particles found accounted for by each 
## colour/type of particles
oystersummarytable <- with(oysterdep4, tapply(value, variable, sum))
oystersummarytable <- oystersummarytable/sum(oysterdep4$value)*100
print(oystersummarytable)
```

### Blanks
Now load in the blanks dataset and set it up for plotting, same as with the oyster data set. First we load in the data.

```{r}
depblanks <- 
  read.csv("~/GRAD school/ACRDP/Depuration/Data/Analysis/depblanks.csv")

head(depblanks)

depblanks$id <- as.factor(depblanks$id)
depblanks$size.cat <- as.factor(depblanks$size.cat)
depblanks$observer <- as.factor(depblanks$observer)
```

Now we make a new dataframe to work with and rename size categories.

```{r}
depblanks2 <- depblanks

depblanks2$size.cat <- factor(depblanks2$size.cat, 
                              levels=c('twentyto50', 'fiftyto100',
                                       'onehundredto500', 'fivehundredto1000', 
                                       'onethousandto5000'))  # reorder


depblanks2$size.cat <- mapvalues(depblanks2$size.cat, 
                                 from = c('twentyto50', 'fiftyto100', 
                                          'onehundredto500', 
                                          'fivehundredto1000', 
                                          'onethousandto5000'), 
                                 to = c('20-50', '50-100', '100-500',
                                        '500-1000', '1000-5000'))  # rename
summary(depblanks2$size.cat)  # view
```

Again, we melt the dataframe so that the particle types are organized by row instead of by column.

```{r}
depblanks3 <- melt(depblanks2,
                   id.vars = c('id', 'size.cat', 'DOFSample', 'time.in.oven', 
                               'time.out.oven', 'dat.filter', 'dat.count', 
                               'observer'))

##  Take out unnecessary columns

depblanks3 <- depblanks3[c('id', 'size.cat', 'DOFSample', 'dat.filter', 'dat.count',
                         'observer', 'variable', 'value')]

head(depblanks3)  # now 'variable' is particle category and 'value is the count'
```

Now sum by totals across all samples and particles sizes to get an idea of what we're working with.

```{r}
cat.sums.blanks <- aggregate(depblanks3$value ~ 
                               depblanks3$variable, FUN = sum)  # sums everything
print(cat.sums.blanks)
```

So we can remove the red, yellow, green turquoise, purple, gray, brown, orange, and black fibre categories, and all other categories other than blue fragements.

```{r}
depblanks4 <- subset(depblanks3, c(variable == 'blu.fib' | 
                       variable == 'clear.fib' | variable == 'pink.fib' |
                       variable == 'blu.frag'))  # keep only these rows

depblanks4$variable <- as.character(depblanks4$variable)
depblanks4$variable <- as.factor(depblanks4$variable)  # gets rid of those names

summary(depblanks4$variable)  # view
```

Let's make the category names a bit more useful for plotting

```{r}
depblanks4$variable <- mapvalues(depblanks4$variable,
                                 from = c(levels(depblanks4$variable)), 
                                 to = c('Blue fibres', 'Blue fragments', 
                                        'Clear fibres', 'Pink fibres'))

## And reorder them
depblanks4$variable <- factor(depblanks4$variable, 
                              levels = c('Blue fibres', 'Clear fibres',
                                         'Pink fibres', 'Blue fragments'))

summary(depblanks4$variable)
```

Take total sums and plot the results.

```{r}
totalblanksums <- ddply(depblanks4, c('id', 'observer', 'dat.filter', 'DOFSample'),
                   summarise, sum = sum(value))  # adds all the counts together

## Plot according to count per filtration day

ggplot(totalblanksums, aes(x=DOFSample, y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab('Day') + 
  ylab('# APs') +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

Now do the same summary stats for the blanks

```{r}
## Means, range, and SD

with(totalblanksums, tapply(sum, DOFSample, mean))  # takes mean for each day
with(totalblanksums, tapply(sum, DOFSample, min))  # takes minimum for each day
with(totalblanksums, tapply(sum, DOFSample, max))  # takes maximum for each day
with(totalblanksums, tapply(sum, 
                       DOFSample, sd))  # takes standard deviation for each day

## Proportions of particles sizes

sum(depblanks4$value[depblanks4$size.cat == '10-20'])/
  sum(depblanks4$value)*100  # 0%

sum(depblanks4$value[depblanks4$size.cat == '20-50'])/
  sum(depblanks4$value)*100  # 2.63 %

sum(depblanks4$value[depblanks4$size.cat == '50-100'])/
  sum(depblanks4$value)*100  # 2.63 %

sum(depblanks4$value[depblanks4$size.cat == '100-500'])/
  sum(depblanks4$value)*100  # 42.11 %

sum(depblanks4$value[depblanks4$size.cat == '500-1000'])/
  sum(depblanks4$value)*100  # 23.68 %

sum(depblanks4$value[depblanks4$size.cat == '1000-5000'])/
  sum(depblanks4$value)*100  # 28.95 %

## This provides the percentage of total particles found accounted for by each 
## colour/type of particles
blanksummarytable <- with(depblanks4, tapply(value, variable, sum))
blanksummarytable <- blanksummarytable/sum(depblanks4$value)*100
print(blanksummarytable)
```

Now load in the water sample data.

```{r}
depwater <- 
  read.csv("~/GRAD school/ACRDP/Depuration/Data/Analysis/depwater.csv")

head(depwater)

depwater$id <- as.factor(depwater$id)
depwater$day <- as.factor(depwater$day)
depwater$size.cat <- as.factor(depwater$size.cat)
depwater$Table <- as.factor(depwater$Table)
depwater$Tank <- as.factor(depwater$Tank)
depwater$observer <- as.factor(depwater$observer)
```

Now we make a new dataframe to work with and rename size categories.

```{r}
depwater2 <- depwater

depwater2$size.cat <- factor(depwater2$size.cat, 
                              levels=c('twentyto50', 'fiftyto100',
                                       'onehundredto500', 'fivehundredto1000', 
                                       'onethousandto5000'))  # reorder


depwater2$size.cat <- mapvalues(depwater2$size.cat, 
                                 from = c('twentyto50', 'fiftyto100', 
                                          'onehundredto500', 
                                          'fivehundredto1000', 
                                          'onethousandto5000'), 
                                 to = c('20-50', '50-100', '100-500',
                                        '500-1000', '1000-5000'))  # rename
summary(depwater2$size.cat)  # view
```

Again, we melt the dataframe so that the particle types are organized by row instead of by column.

```{r}
depwater3 <- melt(depwater2,
                   id.vars = c('id', 'day', 'size.cat', 'Table', 'Tank', 
                               'DOFSample', 'time.in.oven', 'time.out.oven', 
                               'dat.filter',  'dat.count', 'observer'))

##  Take out unnecessary columns

depwater3 <- depwater3[c('id', 'day', 'size.cat', 'Table', 'Tank', 'DOFSample', 
                         'dat.filter', 'dat.count', 'observer', 'variable', 
                         'value')]

head(depwater3)  # now 'variable' is particle category and 'value is the count'
```

Now sum by totals across all samples and particles sizes to get an idea of what we're working with.

```{r}
cat.sums.blanks <- aggregate(depwater3$value ~ 
                               depwater3$variable, FUN = sum)  # sums everything
print(cat.sums.blanks)
```

So we can remove the yellow, green, purple, gray, pink, brown, orange, and black fibre categories, and all other categories as well.

```{r}
depwater4 <- subset(depwater3, c(variable == 'red.fib' | 
                       variable == 'turq.fib' | variable == 'blu.fib' |
                       variable == 'clear.fib'))  # keep only these rows

depwater4$variable <- as.character(depwater4$variable)
depwater4$variable <- as.factor(depwater4$variable)  # gets rid of those names

summary(depwater4$variable)  # view
```

Let's make the category names a bit more useful for plotting

```{r}
depwater4$variable <- mapvalues(depwater4$variable,
                                 from = c(levels(depwater4$variable)), 
                                 to = c('Blue fibres', 'Clear fibres', 
                                        'Red fibres', 'Turquoise fibres'))

## And reorder them
depwater4$variable <- factor(depwater4$variable, 
                              levels = c('Blue fibres', 'Clear fibres',
                                         'Red fibres', 'Turquoise fibres'))

summary(depwater4$variable)
```

Take total sums and plot the results.

```{r}
totalwatersums <- ddply(depwater4, c('id', 'day', 'Table', 'Tank', 'observer', 
                                     'dat.filter'),
                   summarise, sum = sum(value))  # adds all the counts together

## Plot according to count per filtration day

ggplot(totalwatersums, aes(x=day, y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab('Day') +
  ylab('# APs') +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

Now run the same summary stats for the water samples.

```{r}
## Means, range, and SD

with(totalwatersums, tapply(sum, day, mean))  # takes mean for each day
with(totalwatersums, tapply(sum, day, min))  # takes minimum for each day
with(totalwatersums, tapply(sum, day, max))  # takes maximum for each day
with(totalwatersums, tapply(sum, 
                       day, sd))  # takes standard deviation for each day

## Proportions of particles sizes

sum(depwater4$value[depwater4$size.cat == '10-20'])/
  sum(depwater4$value)*100  # 0%

sum(depwater4$value[depwater4$size.cat == '20-50'])/
  sum(depwater4$value)*100  # 0 %

sum(depwater4$value[depwater4$size.cat == '50-100'])/
  sum(depwater4$value)*100  # 0 %

sum(depwater4$value[depwater4$size.cat == '100-500'])/
  sum(depwater4$value)*100  # 20.83 %

sum(depwater4$value[depwater4$size.cat == '500-1000'])/
  sum(depwater4$value)*100  # 31.25 %

sum(depwater4$value[depwater4$size.cat == '1000-5000'])/
  sum(depwater4$value)*100  # 47.92 %

## This provides the percentage of total particles found accounted for by each 
## colour/type of particles
watersummarytable <- with(depwater4, tapply(value, variable, sum))
watersummarytable <- watersummarytable/sum(depwater4$value)*100
print(watersummarytable)
```

## MODELLING
Now fit a generalized linear mixed model (GLMM) to the oyster data using the package glmmADMB to determine differences over time. We'll specify AP count as the response variable, sampling day as the predictor, and tank nested within table as the random, or mixed, effects. You'll notice that sample day is specified twice. The second time is to set it up as the intercept for the random effect, which will allow the linear relationship between AP sum and sampling day to vary in both slope and intercept according separately within each tank, within each table. This accounts for any the variation that may have been caused by any variables that we did not account for and may have varied somehow in different tanks and or/tables.

```{r}
M1 <- glmmadmb(sum ~ sampleday + (sampleday | Table/Tank), family = 'poisson', 
               data = totalsums) ## Fits a GLMM

summary(M1) # model output
plot(resid(M1) ~ fitted(M1)) # plot residuals vs. fitted
plot(resid(M1) ~ totalsums$sampleday) # plot residuals vs. predictor
```

Looking at the plot of residuals vs. fitted and residuals vs. sampe day, we can see that the variance of the residuals varies according to the AP count and the sampling day. This violates the assumption of homogeneity of variance.

Let's try fitting the same model structure, but assuming that the response variable (AP count) varies at each value of x (sampling day) according to a negative binomial distribution.

```{r}
M2 <- glmmadmb(sum ~ sampleday + (sampleday | Table/Tank), family = 'nbinom', 
               data = totalsums) ## Fits a NB GLMM

summary(M2) # model output
plot(resid(M2) ~ fitted(M2)) # plot residuals vs. fitted
plot(resid(M2) ~ totalsums$sampleday) # plot residuals vs. predictor
```

This model is a much better fit, and the variance is much more evenly distributed across the model predictions and across the predictor variable (sampling day).

Now let's try pulling out the predictor (sampling day) and using the anova() function to compare the first model with the null models to determine whether sampling day significantly predicts AP concentration.

```{r}
M3 <- glmmadmb(sum ~ (sampleday | Table/Tank), family = 'nbinom', 
               data = totalsums) ## Same structure except no predictor

anova(M2, M3) # compare the null model with the previously fitted model
```

Sampling day is significant with a p-value of <0.001. We can now go into the model to determine which days are significantly different from each other. Looking back at the summar of M2 we can see that day 3 is the only time where the AP concentrations are not significantly different from day 0 (the reference level).

Now we reorder the levels in sampleday to vary the reference level and figure out which days are significantly different from which other days.

```{r}
totalsums$sampleday <- relevel(totalsums$sampleday, '1')
M2 <- glmmadmb(sum ~ sampleday + (sampleday | Table/Tank), family = 'nbinom', 
               data = totalsums) ## Fits a NB GLMM

summary(M2) # model output
```

Similarly, day 3 is the only day not significantly different from day 1.

```{r}
totalsums$sampleday <- relevel(totalsums$sampleday, '3')
M2 <- glmmadmb(sum ~ sampleday + (sampleday | Table/Tank), family = 'nbinom', 
               data = totalsums) ## Fits a NB GLMM

summary(M2) # model output
```

Only days 5 and 10 are significantly different from day 3.

```{r}
totalsums$sampleday <- relevel(totalsums$sampleday, '5')
M2 <- glmmadmb(sum ~ sampleday + (sampleday | Table/Tank), family = 'nbinom', 
               data = totalsums) ## Fits a NB GLMM

summary(M2) # model output
```

Day 10 is the only day not significantly different from day 5.

So in summary:

Day | 0 | 1 | 3 | 5 | 10
-------------------------
0   | x |sig| - |sig| sig 
-------------------------
1   | x | x | - |sig| sig
-------------------------
3   | x | x | x |sig| sig
-------------------------
5   | x | x | x | x | -
-------------------------
10  | x | x | x | x | x

Now let's replot the data with letters used to indicate which days are significantly different from one another. Those with different letters are statistically different.

```{r}

## First we have to get the days back in the right order

totalsums$sampleday <- factor(totalsums$sampleday, 
                              levels = c("0","1","3","5", "10"))

## Now plot

ggplot(totalsums, aes(x=sampleday , y=sum)) + 
  geom_boxplot(position=position_dodge(), size=1) + 
  xlab('Day') + 
  coord_cartesian(ylim = c(0, 41)) +
  ylab('# APs') +
  guides(fill=FALSE) +
  theme_bw() +
  theme(text = element_text(size=12), 
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        strip.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  annotate("text", x=1, y=27, label = "A") + 
  annotate("text", x=2, y=32, label = "B") +
  annotate("text", x=3, y=30, label = "A,B") +
  annotate("text", x=4, y=7, label = "C") +
  annotate("text", x=5, y=12, label = "C")


```